<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>របាយការណ៍ស្កេនសិស្ស</title>
    <script>
        // Check login: if not logged in, redirect to login page
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        /* [CSS styles remain the same as your original code] */
        /* ... existing CSS code ... */
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header">
            <h1>📊 របាយការណ៍ស្កេនសិស្ស</h1>
            <p>ប្រព័ន្ធគ្រប់គ្រង និងវិភាគទិន្នន័យស្កេនសិស្ស</p>
        </div>
        
        <!-- Back Buttons -->
        <div class="back-buttons">
            <button class="btn btn-primary" onclick="goToHome()">
                🏠 ត្រលប់ទៅទំព័រដើម
            </button>
            <button class="btn btn-secondary" onclick="goToScanner()">
                🔍 ទៅកាន់ទំព័រស្កេន
            </button>
        </div>
        
        <!-- Main Content -->
        <div class="content">
            <!-- Report Type Selection -->
            <div class="report-type-selection">
                <div class="card">
                    <h2 class="card-title">📋 ជ្រើសរើសប្រភេទរបាយការណ៍</h2>
                    <div class="report-type-grid">
                        <div class="report-type-card" data-type="late" onclick="selectReportType('late')">
                            <div class="report-type-icon">⏰</div>
                            <div class="report-type-title">សិស្សមកយឺត</div>
                            <div class="report-type-desc">របាយការណ៍សិស្សដែលមកយឺត មិនគោរពទង់ជាតិ</div>
                        </div>
                        <div class="report-type-card" data-type="discipline" onclick="selectReportType('discipline')">
                            <div class="report-type-icon">⚠️</div>
                            <div class="report-type-title">សិស្សមិនគោរពវិន័យ</div>
                            <div class="report-type-desc">របាយការណ៍សិស្សដែលមិនគោរពវិន័យសាលា</div>
                        </div>
                        <div class="report-type-card" data-type="helpful" onclick="selectReportType('helpful')">
                            <div class="report-type-icon">🤝</div>
                            <div class="report-type-title">សិស្សជួយការងារ</div>
                            <div class="report-type-desc">របាយការណ៍សិស្សដែលបានជួយការងារសាលា</div>
                        </div>
                        <div class="report-type-card" data-type="haircut" onclick="selectReportType('haircut')">
                            <div class="report-type-icon">💇</div>
                            <div class="report-type-title">សិស្សត្រូវកាត់សក់</div>
                            <div class="report-type-desc">របាយការណ៍សិស្សដែលត្រូវកាត់សក់តាមវិន័យ</div>
                        </div>
                        <div class="report-type-card" data-type="summary" onclick="selectReportType('summary')">
                            <div class="report-type-icon">📈</div>
                            <div class="report-type-title">របាយការណ៍សង្ខេប</div>
                            <div class="report-type-desc">របាយការណ៍ចំនួនដងសិស្សមកយឺតក្នុងមួយសប្តាហ៍/ខែ</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Current Report Type Display -->
            <div id="current-report-type" class="card" style="display: none;">
                <h2 class="card-title" id="current-report-title">របាយការណ៍សិស្សមកយឺត</h2>
                <p id="current-report-description">របាយការណ៍សិស្សដែលមកយឺត មិនគោរពទង់ជាតិ</p>
            </div>

            <!-- Summary Report Section -->
            <div id="summary-section" class="card" style="display: none;">
                <h2 class="card-title">📈 របាយការណ៍ចំនួនដងសិស្សមកយឺត</h2>
                
                <div class="filter-section">
                    <div class="filter-grid">
                        <div class="form-group">
                            <label for="summary-period">រយៈពេល</label>
                            <select id="summary-period" class="form-control" onchange="updateSummaryReport()">
                                <option value="week">មួយសប្តាហ៍</option>
                                <option value="month">មួយខែ</option>
                                <option value="custom">កាលបរិច្ឆេទជាក់លាក់</option>
                            </select>
                        </div>
                        <div class="form-group" id="custom-summary-date-group" style="display: none;">
                            <label for="custom-summary-date">ជ្រើសរើសកាលបរិច្ឆេទ</label>
                            <input type="date" id="custom-summary-date" class="form-control" onchange="updateSummaryReport()">
                        </div>
                        <div class="form-group">
                            <label for="summary-class-filter">ថ្នាក់</label>
                            <select id="summary-class-filter" class="form-control" onchange="updateSummaryReport()">
                                <option value="all">ទាំងអស់</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="min-late-count">ចំនួនដងយឺតយ៉ាងតិច</label>
                            <input type="number" id="min-late-count" class="form-control" value="1" min="1" onchange="updateSummaryReport()">
                        </div>
                    </div>
                </div>

                <!-- Summary Stats -->
                <div class="summary-card">
                    <div class="summary-title">
                        📊 ស្ថិតិសង្ខេប
                    </div>
                    <div class="summary-stats">
                        <div class="summary-stat">
                            <div class="summary-number" id="total-students-late">0</div>
                            <div class="summary-label">សិស្សមកយឺតសរុប</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-number" id="total-late-count">0</div>
                            <div class="summary-label">ចំនួនដងមកយឺតសរុប</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-number" id="avg-late-per-student">0</div>
                            <div class="summary-label">មធ្យមដងមកយឺតក្នុងមួយសិស្ស</div>
                        </div>
                        <div class="summary-stat">
                            <div class="summary-number" id="max-late-count">0</div>
                            <div class="summary-label">ចំនួនដងមកយឺតខ្ពស់ជាងគេ</div>
                        </div>
                    </div>
                </div>

                <!-- Summary Table -->
                <div class="table-container">
                    <table class="data-table" id="summary-table">
                        <thead>
                            <tr>
                                <th>ល.រ</th>
                                <th>ឈ្មោះសិស្ស</th>
                                <th>ថ្នាក់</th>
                                <th>ភេទ</th>
                                <th>ចំនួនដងមកយឺត</th>
                                <th>ថ្ងៃចុងក្រោយដែលមកយឺត</th>
                                <th>ស្ថានភាព</th>
                            </tr>
                        </thead>
                        <tbody id="summary-table-body">
                            <!-- Data will be populated here -->
                        </tbody>
                    </table>
                </div>
                <div id="summary-empty" class="empty-state" style="display: none;">
                    <div class="empty-state-icon">📭</div>
                    <h3>មិនមានទិន្នន័យ</h3>
                    <p>មិនមានសិស្សមកយឺតក្នុងរយៈពេលដែលបានជ្រើសរើស</p>
                </div>
                <div id="summary-loading" class="empty-state">
                    <div class="loading"></div>
                    <p>កំពុងផ្ទុកទិន្នន័យ...</p>
                </div>

                <!-- Export Buttons -->
                <div style="display: flex; gap: 10px; margin-top: 20px; justify-content: flex-end;">
                    <button class="btn btn-success" onclick="exportSummaryToExcel()">
                        📊 Export Summary to Excel
                    </button>
                    <button class="btn btn-primary" onclick="printSummaryReport()">
                        🖨️ Print Summary
                    </button>
                </div>
            </div>

            <!-- Filter Section for Regular Reports -->
            <div id="filter-section" class="filter-section" style="display: none;">
                <h3 style="margin-bottom: 20px; color: var(--primary);">🔍 ត្រងទិន្នន័យ</h3>
                <div class="filter-grid">
                    <div class="form-group">
                        <label for="date-filter">កាលបរិច្ឆេទ</label>
                        <select id="date-filter" class="form-control" onchange="applyFilters()">
                            <option value="today">ថ្ងៃនេះ</option>
                            <option value="yesterday">ម្សិលមិញ</option>
                            <option value="week">សប្តាហ៍នេះ</option>
                            <option value="month">ខែនេះ</option>
                            <option value="custom">កាលបរិច្ឆេទជាក់លាក់</option>
                        </select>
                    </div>
                    <div class="form-group" id="custom-date-group" style="display: none;">
                        <label for="custom-date">ជ្រើសរើសកាលបរិច្ឆេទ</label>
                        <input type="date" id="custom-date" class="form-control" onchange="applyFilters()">
                    </div>
                    <div class="form-group">
                        <label for="class-filter">ថ្នាក់</label>
                        <select id="class-filter" class="form-control" onchange="applyFilters()">
                            <option value="all">ទាំងអស់</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="search-filter">ស្វែងរក</label>
                        <input type="text" id="search-filter" class="form-control" placeholder="ឈ្មោះ ឬអត្តលេខសិស្ស..." onkeyup="applyFilters()">
                    </div>
                </div>
            </div>

            <!-- Stats Section -->
            <div id="stats-section" class="stats-grid" style="display: none;">
                <div class="stat-card">
                    <div class="stat-number" id="total-scans">0</div>
                    <div class="stat-label">ស្កេនសរុប</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="today-scans">0</div>
                    <div class="stat-label">ស្កេនថ្ងៃនេះ</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="unique-students">0</div>
                    <div class="stat-label">សិស្សផ្សេងគ្នា</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="most-frequent">0</div>
                    <div class="stat-label">ស្កេនច្រើនជាងគេ</div>
                </div>
            </div>

            <!-- Chart Section -->
            <div id="chart-section" style="display: none;">
                <div class="card">
                    <h2 class="card-title">📈 តារាងស្ថិតិ</h2>
                    <div class="chart-container">
                        <canvas id="reportChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Data Table for Regular Reports -->
            <div id="table-section" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: between; align-items: center; margin-bottom: 20px;">
                        <h2 class="card-title">📋 ទិន្នន័យស្កេន</h2>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-success" onclick="exportToExcel()">
                                📊 Export to Excel
                            </button>
                            <button class="btn btn-primary" onclick="printReport()">
                                🖨️ Print
                            </button>
                        </div>
                    </div>
                    <div class="table-container">
                        <table class="data-table" id="report-table">
                            <thead>
                                <tr>
                                    <th>ល.រ</th>
                                    <th>ឈ្មោះសិស្ស</th>
                                    <th>ថ្នាក់</th>
                                    <th>ភេទ</th>
                                    <th>ពេលវេលា</th>
                                    <th>កាលបរិច្ឆេទ</th>
                                    <th>ប្រភេទ</th>
                                </tr>
                            </thead>
                            <tbody id="report-table-body">
                                <!-- Data will be populated here -->
                            </tbody>
                        </table>
                    </div>
                    <div id="table-empty" class="empty-state" style="display: none;">
                        <div class="empty-state-icon">📭</div>
                        <h3>មិនមានទិន្នន័យ</h3>
                        <p>មិនមានទិន្នន័យស្កេនសម្រាប់ប្រភេទនេះនៅឡើយ</p>
                    </div>
                    <div id="table-loading" class="empty-state">
                        <div class="loading"></div>
                        <p>កំពុងផ្ទុកទិន្នន័យ...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ovvlshbuayykddqrnoqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dmxzaGJ1YXl5a2RkcXJub3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjQxODgsImV4cCI6MjA3NjM0MDE4OH0.vWLDFMS16PwZga9mYehVUiL6G0ccnRzdc9OUf2OM76I';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentReportType = null;
        let allReports = [];
        let filteredReports = [];
        let chart = null;
        let students = [];
        let summaryData = [];

        // Report type definitions
        const reportTypes = {
            late: {
                title: "សិស្សមកយឺត",
                description: "របាយការណ៍សិស្សដែលមកយឺត មិនគោរពទង់ជាតិ",
                table: "attendance_reports",
                type: "late",
                badge: "badge-late",
                badgeText: "មកយឺត"
            },
            discipline: {
                title: "សិស្សមិនគោរពវិន័យ",
                description: "របាយការណ៍សិស្សដែលមិនគោរពវិន័យសាលា",
                table: "discipline_reports",
                type: "discipline",
                badge: "badge-discipline",
                badgeText: "មិនគោរពវិន័យ"
            },
            helpful: {
                title: "សិស្សជួយការងារ",
                description: "របាយការណ៍សិស្សដែលបានជួយការងារសាលា",
                table: "helpful_reports",
                type: "helpful",
                badge: "badge-helpful",
                badgeText: "ជួយការងារ"
            },
            haircut: {
                title: "សិស្សត្រូវកាត់សក់",
                description: "របាយការណ៍សិស្សដែលត្រូវកាត់សក់តាមវិន័យ",
                table: "haircut_reports",
                type: "haircut",
                badge: "badge-haircut",
                badgeText: "ត្រូវកាត់សក់"
            },
            summary: {
                title: "របាយការណ៍សង្ខេប",
                description: "របាយការណ៍ចំនួនដងសិស្សមកយឺតក្នុងមួយសប្តាហ៍/ខែ",
                table: "attendance_reports",
                type: "summary"
            }
        };

        // ជ្រើសរើសប្រភេទរបាយការណ៍
        function selectReportType(type) {
            // Remove selected class from all cards
            document.querySelectorAll('.report-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            
            // Add selected class to clicked card
            document.querySelector(`.report-type-card[data-type="${type}"]`).classList.add('selected');
            
            // Store selected type
            currentReportType = type;
            
            // Update current report type display
            document.getElementById('current-report-title').textContent = `របាយការណ៍${reportTypes[type].title}`;
            document.getElementById('current-report-description').textContent = reportTypes[type].description;
            document.getElementById('current-report-type').style.display = 'block';
            
            // Show/hide appropriate sections
            if (type === 'summary') {
                document.getElementById('filter-section').style.display = 'none';
                document.getElementById('stats-section').style.display = 'none';
                document.getElementById('chart-section').style.display = 'none';
                document.getElementById('table-section').style.display = 'none';
                document.getElementById('summary-section').style.display = 'block';
                loadSummaryReport();
            } else {
                document.getElementById('filter-section').style.display = 'block';
                document.getElementById('stats-section').style.display = 'none';
                document.getElementById('chart-section').style.display = 'none';
                document.getElementById('table-section').style.display = 'none';
                document.getElementById('summary-section').style.display = 'none';
                loadReportData();
            }
            
            console.log(`✅ Selected report type: ${type} - ${reportTypes[type].title}`);
        }

        // ផ្ទុកទិន្នន័យរបាយការណ៍សង្ខេប
        async function loadSummaryReport() {
            if (currentReportType !== 'summary') return;
            
            // Show loading state
            document.getElementById('summary-loading').style.display = 'block';
            document.getElementById('summary-empty').style.display = 'none';
            document.getElementById('summary-table-body').innerHTML = '';
            
            try {
                // Load late student data
                const tableName = "attendance_reports";
                console.log(`🔍 Loading summary data from ${tableName}...`);
                
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .order('timestamp', { ascending: false });
                
                if (error) {
                    if (error.code === 'PGRST301') {
                        console.log(`Table ${tableName} doesn't exist, trying localStorage...`);
                        allReports = JSON.parse(localStorage.getItem('lateReports') || '[]');
                    } else {
                        throw error;
                    }
                } else {
                    allReports = data || [];
                    console.log(`✅ Loaded ${allReports.length} records for summary from Supabase`);
                }
                
                // Update summary report
                updateSummaryReport();
                
            } catch (error) {
                console.error('❌ Error loading summary data:', error);
                
                // Fallback to localStorage
                allReports = JSON.parse(localStorage.getItem('lateReports') || '[]');
                console.log(`📱 Fallback to localStorage: ${allReports.length} records`);
                
                updateSummaryReport();
            }
        }

        // ធ្វើបច្ចុប្បន្នភាពរបាយការណ៍សង្ខេប
        function updateSummaryReport() {
            if (currentReportType !== 'summary' || allReports.length === 0) {
                document.getElementById('summary-loading').style.display = 'none';
                document.getElementById('summary-empty').style.display = 'block';
                return;
            }
            
            const period = document.getElementById('summary-period').value;
            const minLateCount = parseInt(document.getElementById('min-late-count').value) || 1;
            const classFilter = document.getElementById('summary-class-filter').value;
            
            // Calculate date range
            const today = new Date();
            let startDate, endDate;
            
            switch (period) {
                case 'week':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    endDate = today;
                    break;
                case 'month':
                    startDate = new Date(today);
                    startDate.setMonth(today.getMonth() - 1);
                    endDate = today;
                    break;
                case 'custom':
                    const customDate = document.getElementById('custom-summary-date').value;
                    if (customDate) {
                        startDate = new Date(customDate);
                        endDate = new Date(customDate);
                        // For custom date, show data for that specific date only
                        startDate.setHours(0, 0, 0, 0);
                        endDate.setHours(23, 59, 59, 999);
                    } else {
                        startDate = new Date(today);
                        startDate.setDate(today.getDate() - 7);
                        endDate = today;
                    }
                    break;
                default:
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - 7);
                    endDate = today;
            }
            
            // Ensure dates are properly set
            startDate.setHours(0, 0, 0, 0);
            endDate.setHours(23, 59, 59, 999);
            
            console.log(`📅 Date range: ${startDate.toISOString()} to ${endDate.toISOString()}`);
            
            // Filter reports by date range
            const filteredByDate = allReports.filter(report => {
                const reportDate = new Date(report.date);
                return reportDate >= startDate && reportDate <= endDate;
            });
            
            console.log(`📊 Filtered ${filteredByDate.length} records by date range`);
            
            // Group by student and count late occurrences
            const studentLateCounts = {};
            const studentLastLateDate = {};
            const studentDetails = {};
            
            filteredByDate.forEach(report => {
                const studentId = report.student_id;
                
                if (!studentLateCounts[studentId]) {
                    studentLateCounts[studentId] = 0;
                    studentDetails[studentId] = {
                        name: report.name,
                        class: report.class,
                        gender: report.gender || 'មិនមានទិន្នន័យ'
                    };
                }
                
                studentLateCounts[studentId]++;
                
                // Track last late date
                const reportDate = new Date(report.date);
                if (!studentLastLateDate[studentId] || reportDate > studentLastLateDate[studentId]) {
                    studentLastLateDate[studentId] = reportDate;
                }
            });
            
            // Convert to array and apply filters
            summaryData = Object.keys(studentLateCounts)
                .map(studentId => ({
                    student_id: studentId,
                    name: studentDetails[studentId].name,
                    class: studentDetails[studentId].class,
                    gender: studentDetails[studentId].gender,
                    late_count: studentLateCounts[studentId],
                    last_late_date: studentLastLateDate[studentId]
                }))
                .filter(student => student.late_count >= minLateCount)
                .filter(student => classFilter === 'all' || student.class === classFilter)
                .sort((a, b) => b.late_count - a.late_count);
            
            console.log(`🎯 Final summary data: ${summaryData.length} students`);
            
            renderSummaryTable();
            updateSummaryStats();
            populateSummaryClassFilter();
        }

        // បង្ហាញតារាងសង្ខេប
        function renderSummaryTable() {
            const tableBody = document.getElementById('summary-table-body');
            const summaryLoading = document.getElementById('summary-loading');
            const summaryEmpty = document.getElementById('summary-empty');
            
            summaryLoading.style.display = 'none';
            
            if (summaryData.length === 0) {
                summaryEmpty.style.display = 'block';
                tableBody.innerHTML = '';
                return;
            }
            
            summaryEmpty.style.display = 'none';
            
            let html = '';
            summaryData.forEach((student, index) => {
                const lastLateDate = student.last_late_date.toLocaleDateString('km-KH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                // Determine status based on late count
                let status = '';
                let statusClass = '';
                
                if (student.late_count >= 5) {
                    status = 'យឺតច្រើនណាស់';
                    statusClass = 'badge-late'; // Using existing badge class
                } else if (student.late_count >= 3) {
                    status = 'យឺតច្រើន';
                    statusClass = 'badge-warning';
                } else {
                    status = 'យឺតតិច';
                    statusClass = 'badge-helpful'; // Using existing badge class
                }
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div><strong>${student.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--gray);">ID: ${student.student_id}</div>
                        </td>
                        <td>${student.class}</td>
                        <td>${student.gender}</td>
                        <td><strong style="color: var(--danger); font-size: 1.1rem;">${student.late_count}</strong> ដង</td>
                        <td>${lastLateDate}</td>
                        <td><span class="badge ${statusClass}">${status}</span></td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
        }

        // ធ្វើបច្ចុប្បន្នភាពស្ថិតិសង្ខេប
        function updateSummaryStats() {
            if (summaryData.length === 0) {
                document.getElementById('total-students-late').textContent = '0';
                document.getElementById('total-late-count').textContent = '0';
                document.getElementById('avg-late-per-student').textContent = '0';
                document.getElementById('max-late-count').textContent = '0';
                return;
            }
            
            const totalStudents = summaryData.length;
            const totalLateCount = summaryData.reduce((sum, student) => sum + student.late_count, 0);
            const avgLatePerStudent = (totalLateCount / totalStudents).toFixed(1);
            const maxLateCount = Math.max(...summaryData.map(student => student.late_count));
            
            document.getElementById('total-students-late').textContent = totalStudents;
            document.getElementById('total-late-count').textContent = totalLateCount;
            document.getElementById('avg-late-per-student').textContent = avgLatePerStudent;
            document.getElementById('max-late-count').textContent = maxLateCount;
            
            // Show stats section
            document.getElementById('stats-section').style.display = 'grid';
        }

        // បំពេញតម្រៀបថ្នាក់សម្រាប់របាយការណ៍សង្ខេប
        function populateSummaryClassFilter() {
            const classFilter = document.getElementById('summary-class-filter');
            
            // Get unique classes from all reports (not just summary data)
            const classes = [...new Set(allReports.map(report => report.class))].sort();
            
            // Clear existing options except "all"
            classFilter.innerHTML = '<option value="all">ទាំងអស់</option>';
            
            // Add class options
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        // នាំចេញរបាយការណ៍សង្ខេបទៅជា Excel
        function exportSummaryToExcel() {
            if (summaryData.length === 0) {
                alert('❗ មិនមានទិន្នន័យដើម្បីនាំចេញ');
                return;
            }
            
            try {
                // Prepare data for Excel
                const excelData = summaryData.map((student, index) => {
                    const lastLateDate = student.last_late_date.toLocaleDateString('km-KH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    // Determine status
                    let status = '';
                    if (student.late_count >= 5) {
                        status = 'យឺតច្រើនណាស់';
                    } else if (student.late_count >= 3) {
                        status = 'យឺតច្រើន';
                    } else {
                        status = 'យឺតតិច';
                    }
                    
                    return {
                        'ល.រ': index + 1,
                        'ឈ្មោះសិស្ស': student.name,
                        'អត្តលេខ': student.student_id,
                        'ថ្នាក់': student.class,
                        'ភេទ': student.gender,
                        'ចំនួនដងមកយឺត': student.late_count,
                        'ថ្ងៃចុងក្រោយដែលមកយឺត': lastLateDate,
                        'ស្ថានភាព': status
                    };
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'របាយការណ៍សង្ខេបសិស្សមកយឺត');
                
                // Generate filename
                const today = new Date().toISOString().split('T')[0];
                const filename = `របាយការណ៍សង្ខេបសិស្សមកយឺត_${today}.xlsx`;
                
                // Export to Excel
                XLSX.writeFile(wb, filename);
                
                console.log(`✅ Exported ${summaryData.length} summary records to Excel`);
            } catch (error) {
                console.error('❌ Error exporting summary to Excel:', error);
                alert('❗ កំហុសក្នុងការនាំចេញទិន្នន័យ: ' + error.message);
            }
        }

        // បោះពុម្ពរបាយការណ៍សង្ខេប
        function printSummaryReport() {
            if (summaryData.length === 0) {
                alert('❗ មិនមានទិន្នន័យដើម្បីបោះពុម្ព');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const today = new Date().toLocaleDateString('km-KH');
            const period = document.getElementById('summary-period').value;
            const periodText = period === 'week' ? 'មួយសប្តាហ៍' : period === 'month' ? 'មួយខែ' : 'កាលបរិច្ឆេទជាក់លាក់';
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="km">
                <head>
                    <meta charset="UTF-8">
                    <title>របាយការណ៍សង្ខេបសិស្សមកយឺត</title>
                    <style>
                        body { font-family: 'Khmer OS', 'Arial', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { color: #333; margin-bottom: 10px; }
                        .header .date { color: #666; }
                        .summary-info { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9em; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>របាយការណ៍សង្ខេបសិស្សមកយឺត</h1>
                        <div class="date">កាលបរិច្ឆេទ: ${today}</div>
                        <div class="date">រយៈពេល: ${periodText}</div>
                        <div class="date">ចំនួនសិស្សមកយឺត: ${summaryData.length}</div>
                    </div>
                    <div class="summary-info">
                        <strong>ស្ថិតិសង្ខេប:</strong><br>
                        - សិស្សមកយឺតសរុប: ${summaryData.length} នាក់<br>
                        - ចំនួនដងមកយឺតសរុប: ${summaryData.reduce((sum, student) => sum + student.late_count, 0)} ដង<br>
                        - មធ្យមដងមកយឺតក្នុងមួយសិស្ស: ${(summaryData.reduce((sum, student) => sum + student.late_count, 0) / summaryData.length).toFixed(1)} ដង<br>
                        - ចំនួនដងមកយឺតខ្ពស់ជាងគេ: ${Math.max(...summaryData.map(student => student.late_count))} ដង
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ល.រ</th>
                                <th>ឈ្មោះសិស្ស</th>
                                <th>ថ្នាក់</th>
                                <th>ភេទ</th>
                                <th>ចំនួនដងមកយឺត</th>
                                <th>ថ្ងៃចុងក្រោយដែលមកយឺត</th>
                                <th>ស្ថានភាព</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${summaryData.map((student, index) => {
                                const lastLateDate = student.last_late_date.toLocaleDateString('km-KH', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                
                                let status = '';
                                if (student.late_count >= 5) {
                                    status = 'យឺតច្រើនណាស់';
                                } else if (student.late_count >= 3) {
                                    status = 'យឺតច្រើន';
                                } else {
                                    status = 'យឺតតិច';
                                }
                                
                                return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${student.name}<br><small>ID: ${student.student_id}</small></td>
                                        <td>${student.class}</td>
                                        <td>${student.gender}</td>
                                        <td><strong>${student.late_count} ដង</strong></td>
                                        <td>${lastLateDate}</td>
                                        <td>${status}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>ប្រព័ន្ធគ្រប់គ្រងស្កេនសិស្ស - បានបង្កើតឡើងនៅ ${new Date().toLocaleString('km-KH')}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // Handle summary period change
        document.getElementById('summary-period').addEventListener('change', function() {
            const customDateGroup = document.getElementById('custom-summary-date-group');
            if (this.value === 'custom') {
                customDateGroup.style.display = 'block';
            } else {
                customDateGroup.style.display = 'none';
                updateSummaryReport();
            }
        });

        // ========== REGULAR REPORT FUNCTIONS ==========

        // ផ្ទុកទិន្នន័យរបាយការណ៍
        async function loadReportData() {
            if (!currentReportType || currentReportType === 'summary') return;
            
            // Show loading state
            document.getElementById('table-loading').style.display = 'block';
            document.getElementById('table-empty').style.display = 'none';
            document.getElementById('report-table-body').innerHTML = '';
            
            try {
                const tableName = reportTypes[currentReportType].table;
                console.log(`🔍 Loading data from ${tableName}...`);
                
                // Try to fetch from Supabase first
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .order('timestamp', { ascending: false });
                
                if (error) {
                    // If table doesn't exist, try localStorage
                    if (error.code === 'PGRST301') {
                        console.log(`Table ${tableName} doesn't exist, trying localStorage...`);
                        allReports = JSON.parse(localStorage.getItem(`${currentReportType}Reports`) || '[]');
                    } else {
                        throw error;
                    }
                } else {
                    allReports = data || [];
                    console.log(`✅ Loaded ${allReports.length} records from Supabase`);
                }
                
                // Apply initial filters
                applyFilters();
                
                // Update stats
                updateStats();
                
                // Update chart
                updateChart();
                
                // Populate class filter
                populateClassFilter();
                
            } catch (error) {
                console.error('❌ Error loading report data:', error);
                
                // Fallback to localStorage
                allReports = JSON.parse(localStorage.getItem(`${currentReportType}Reports`) || '[]');
                console.log(`📱 Fallback to localStorage: ${allReports.length} records`);
                
                applyFilters();
                updateStats();
                updateChart();
                populateClassFilter();
            }
        }

        // ត្រងទិន្នន័យ
        function applyFilters() {
            if (!currentReportType || currentReportType === 'summary' || allReports.length === 0) {
                document.getElementById('table-loading').style.display = 'none';
                document.getElementById('table-empty').style.display = 'block';
                return;
            }
            
            let filtered = [...allReports];
            
            // Apply date filter
            const dateFilter = document.getElementById('date-filter').value;
            const today = new Date();
            
            switch (dateFilter) {
                case 'today':
                    const todayStr = today.toISOString().split('T')[0];
                    filtered = filtered.filter(report => report.date === todayStr);
                    break;
                case 'yesterday':
                    const yesterday = new Date(today);
                    yesterday.setDate(yesterday.getDate() - 1);
                    const yesterdayStr = yesterday.toISOString().split('T')[0];
                    filtered = filtered.filter(report => report.date === yesterdayStr);
                    break;
                case 'week':
                    const weekAgo = new Date(today);
                    weekAgo.setDate(weekAgo.getDate() - 7);
                    filtered = filtered.filter(report => {
                        const reportDate = new Date(report.date);
                        return reportDate >= weekAgo && reportDate <= today;
                    });
                    break;
                case 'month':
                    const monthAgo = new Date(today);
                    monthAgo.setMonth(monthAgo.getMonth() - 1);
                    filtered = filtered.filter(report => {
                        const reportDate = new Date(report.date);
                        return reportDate >= monthAgo && reportDate <= today;
                    });
                    break;
                case 'custom':
                    const customDate = document.getElementById('custom-date').value;
                    if (customDate) {
                        filtered = filtered.filter(report => report.date === customDate);
                    }
                    break;
            }
            
            // Apply class filter
            const classFilter = document.getElementById('class-filter').value;
            if (classFilter !== 'all') {
                filtered = filtered.filter(report => report.class === classFilter);
            }
            
            // Apply search filter
            const searchFilter = document.getElementById('search-filter').value.toLowerCase();
            if (searchFilter) {
                filtered = filtered.filter(report => 
                    report.name.toLowerCase().includes(searchFilter) ||
                    (report.student_id && report.student_id.toLowerCase().includes(searchFilter))
                );
            }
            
            filteredReports = filtered;
            renderTable();
            updateStats();
            updateChart();
        }

        // បង្ហាញតារាង
        function renderTable() {
            const tableBody = document.getElementById('report-table-body');
            const tableLoading = document.getElementById('table-loading');
            const tableEmpty = document.getElementById('table-empty');
            
            tableLoading.style.display = 'none';
            
            if (filteredReports.length === 0) {
                tableEmpty.style.display = 'block';
                tableBody.innerHTML = '';
                document.getElementById('stats-section').style.display = 'none';
                document.getElementById('chart-section').style.display = 'none';
                return;
            }
            
            tableEmpty.style.display = 'none';
            
            let html = '';
            filteredReports.forEach((report, index) => {
                // Format date for display
                const dateObj = new Date(report.date);
                const displayDate = dateObj.toLocaleDateString('km-KH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                html += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>
                            <div><strong>${report.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--gray);">ID: ${report.student_id}</div>
                        </td>
                        <td>${report.class}</td>
                        <td>${report.gender || 'មិនមានទិន្នន័យ'}</td>
                        <td>${report.scan_time || report.late_time || 'N/A'}</td>
                        <td>${displayDate}</td>
                        <td><span class="badge ${reportTypes[currentReportType].badge}">${reportTypes[currentReportType].badgeText}</span></td>
                    </tr>
                `;
            });
            
            tableBody.innerHTML = html;
            document.getElementById('table-section').style.display = 'block';
            document.getElementById('stats-section').style.display = 'grid';
            document.getElementById('chart-section').style.display = 'block';
        }

        // ធ្វើបច្ចុប្បន្នភាពស្ថិតិ
        function updateStats() {
            if (!currentReportType || currentReportType === 'summary') return;
            
            const totalScans = allReports.length;
            const todayScans = allReports.filter(report => {
                const today = new Date().toISOString().split('T')[0];
                return report.date === today;
            }).length;
            
            // Count unique students
            const uniqueStudents = new Set(allReports.map(report => report.student_id)).size;
            
            // Find most frequent student
            const studentCounts = {};
            allReports.forEach(report => {
                studentCounts[report.student_id] = (studentCounts[report.student_id] || 0) + 1;
            });
            
            const mostFrequent = Math.max(...Object.values(studentCounts), 0);
            
            document.getElementById('total-scans').textContent = totalScans;
            document.getElementById('today-scans').textContent = todayScans;
            document.getElementById('unique-students').textContent = uniqueStudents;
            document.getElementById('most-frequent').textContent = mostFrequent;
        }

        // ធ្វើបច្ចុប្បន្នភាពតារាង
        function updateChart() {
            if (!currentReportType || currentReportType === 'summary' || filteredReports.length === 0) {
                return;
            }
            
            // Prepare data for chart - last 7 days
            const last7Days = [];
            for (let i = 6; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                last7Days.push(date.toISOString().split('T')[0]);
            }
            
            const dailyCounts = last7Days.map(date => {
                return filteredReports.filter(report => report.date === date).length;
            });
            
            const chartLabels = last7Days.map(date => {
                const d = new Date(date);
                return d.toLocaleDateString('km-KH', { month: 'short', day: 'numeric' });
            });
            
            const ctx = document.getElementById('reportChart').getContext('2d');
            
            // Destroy existing chart
            if (chart) {
                chart.destroy();
            }
            
            // Create new chart
            chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: `ចំនួនស្កេន${reportTypes[currentReportType].title}`,
                        data: dailyCounts,
                        backgroundColor: '#4361ee',
                        borderColor: '#3a56d4',
                        borderWidth: 2,
                        borderRadius: 8,
                        borderSkipped: false,
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: `ស្ថិតិស្កេន${reportTypes[currentReportType].title} ៧ថ្ងៃចុងក្រោយ`,
                            font: {
                                size: 16,
                                family: 'Khmer OS, Noto Sans Khmer, Arial'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0
                            },
                            title: {
                                display: true,
                                text: 'ចំនួនស្កេន'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'កាលបរិច្ឆេទ'
                            }
                        }
                    }
                }
            });
        }

        // បំពេញតម្រៀបថ្នាក់
        function populateClassFilter() {
            const classFilter = document.getElementById('class-filter');
            
            // Get unique classes from reports
            const classes = [...new Set(allReports.map(report => report.class))].sort();
            
            // Clear existing options except "all"
            classFilter.innerHTML = '<option value="all">ទាំងអស់</option>';
            
            // Add class options
            classes.forEach(className => {
                const option = document.createElement('option');
                option.value = className;
                option.textContent = className;
                classFilter.appendChild(option);
            });
        }

        // នាំចេញទៅជា Excel
        function exportToExcel() {
            if (filteredReports.length === 0) {
                alert('❗ មិនមានទិន្នន័យដើម្បីនាំចេញ');
                return;
            }
            
            try {
                // Prepare data for Excel
                const excelData = filteredReports.map((report, index) => {
                    const dateObj = new Date(report.date);
                    const displayDate = dateObj.toLocaleDateString('km-KH', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                    
                    return {
                        'ល.រ': index + 1,
                        'ឈ្មោះសិស្ស': report.name,
                        'អត្តលេខ': report.student_id,
                        'ថ្នាក់': report.class,
                        'ភេទ': report.gender || 'មិនមានទិន្នន័យ',
                        'ពេលវេលា': report.scan_time || report.late_time || 'N/A',
                        'កាលបរិច្ឆេទ': displayDate,
                        'ប្រភេទ': reportTypes[currentReportType].badgeText
                    };
                });
                
                // Create worksheet
                const ws = XLSX.utils.json_to_sheet(excelData);
                
                // Create workbook
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, reportTypes[currentReportType].title);
                
                // Generate filename
                const today = new Date().toISOString().split('T')[0];
                const filename = `${reportTypes[currentReportType].title}_${today}.xlsx`;
                
                // Export to Excel
                XLSX.writeFile(wb, filename);
                
                console.log(`✅ Exported ${filteredReports.length} records to Excel`);
            } catch (error) {
                console.error('❌ Error exporting to Excel:', error);
                alert('❗ កំហុសក្នុងការនាំចេញទិន្នន័យ: ' + error.message);
            }
        }

        // បោះពុម្ពរបាយការណ៍
        function printReport() {
            if (filteredReports.length === 0) {
                alert('❗ មិនមានទិន្នន័យដើម្បីបោះពុម្ព');
                return;
            }
            
            const printWindow = window.open('', '_blank');
            const today = new Date().toLocaleDateString('km-KH');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html lang="km">
                <head>
                    <meta charset="UTF-8">
                    <title>របាយការណ៍${reportTypes[currentReportType].title}</title>
                    <style>
                        body { font-family: 'Khmer OS', 'Arial', sans-serif; margin: 20px; }
                        .header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
                        .header h1 { color: #333; margin-bottom: 10px; }
                        .header .date { color: #666; }
                        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                        th, td { border: 1px solid #ddd; padding: 10px; text-align: left; }
                        th { background-color: #f5f5f5; font-weight: bold; }
                        .summary { margin: 20px 0; padding: 15px; background: #f9f9f9; border-radius: 5px; }
                        .footer { margin-top: 30px; text-align: center; color: #666; font-size: 0.9em; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>របាយការណ៍${reportTypes[currentReportType].title}</h1>
                        <div class="date">កាលបរិច្ឆេទ: ${today}</div>
                        <div class="date">ចំនួនស្កេនសរុប: ${filteredReports.length}</div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ល.រ</th>
                                <th>ឈ្មោះសិស្ស</th>
                                <th>ថ្នាក់</th>
                                <th>ភេទ</th>
                                <th>ពេលវេលា</th>
                                <th>កាលបរិច្ឆេទ</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredReports.map((report, index) => {
                                const dateObj = new Date(report.date);
                                const displayDate = dateObj.toLocaleDateString('km-KH', {
                                    year: 'numeric',
                                    month: 'long',
                                    day: 'numeric'
                                });
                                
                                return `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td>${report.name}<br><small>ID: ${report.student_id}</small></td>
                                        <td>${report.class}</td>
                                        <td>${report.gender || 'មិនមានទិន្នន័យ'}</td>
                                        <td>${report.scan_time || report.late_time || 'N/A'}</td>
                                        <td>${displayDate}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                    <div class="footer">
                        <p>ប្រព័ន្ធគ្រប់គ្រងស្កេនសិស្ស - បានបង្កើតឡើងនៅ ${new Date().toLocaleString('km-KH')}</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
            printWindow.close();
        }

        // Handle date filter change
        document.getElementById('date-filter').addEventListener('change', function() {
            const customDateGroup = document.getElementById('custom-date-group');
            if (this.value === 'custom') {
                customDateGroup.style.display = 'block';
            } else {
                customDateGroup.style.display = 'none';
                applyFilters();
            }
        });

        // Initialize page
        window.onload = function() {
            console.log('📊 Report page loaded');
            // No report type selected by default
        };

        // Function to go back to home page
        function goToHome() {
            window.location.href = 'index.html';
        }

        // Function to go to scanner page
        function goToScanner() {
            window.location.href = 'scan.html';
        }
    </script>
</body>
</html>
