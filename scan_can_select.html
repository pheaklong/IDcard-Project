<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã·ûÄ·û∂·ûö·ûü·üí·ûÄ·üÅ·ûì - ·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûü·û∑·ûü·üí·ûü</title>
    <!-- Mobile meta tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#4361ee">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- JSQR Library -->
    <script src="https://unpkg.com/jsQR@1.4.0/dist/jsQR.js"></script>
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        /* CSS Reset and Base Styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Arial', 'Khmer OS', sans-serif;
        }

        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --warning: #f72585;
            --danger: #f94144;
            --light: #f8f9fa;
            --dark: #212529;
            --border-radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
            -webkit-tap-highlight-color: transparent;
            -webkit-text-size-adjust: 100%;
        }

        /* App Container */
        .app-container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: rgba(255,255,255,0.1);
            transform: rotate(30deg);
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 10px;
            position: relative;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1rem;
            opacity: 0.9;
            position: relative;
        }

        /* Back Buttons */
        .back-buttons {
            display: flex;
            gap: 10px;
            padding: 15px 25px;
            background: var(--light);
            border-bottom: 1px solid #e9ecef;
            flex-wrap: wrap;
        }

        /* Buttons */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 44px;
            text-decoration: none;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
            box-shadow: none !important;
        }

        .btn-primary { 
            background: var(--primary);
            color: white; 
        }
        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success { 
            background: var(--success);
            color: white; 
        }
        
        .btn-warning { 
            background: var(--warning);
            color: white; 
        }
        
        .btn-danger { 
            background: var(--danger);
            color: white; 
        }
        
        .btn-info { 
            background: var(--secondary);
            color: white; 
        }

        /* Content Area */
        .content {
            padding: 25px;
        }

        /* Cards */
        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
        }

        .card h2 {
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.4rem;
        }

        /* Scan Type Grid */
        .scan-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .scan-type-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 160px;
            justify-content: center;
            user-select: none;
        }

        .scan-type-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .scan-type-card.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.08);
            position: relative;
        }

        .scan-type-card.selected::after {
            content: '‚úì';
            position: absolute;
            top: 10px;
            right: 10px;
            background: var(--primary);
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .scan-type-icon {
            font-size: 2.5rem;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .scan-type-title {
            font-weight: 700;
            margin-bottom: 8px;
            font-size: 1.1rem;
            color: #333;
        }

        .scan-type-desc {
            font-size: 0.85rem;
            color: #666;
            line-height: 1.4;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
            padding: 20px;
        }

        .modal-content {
            background: white;
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            animation: slideUp 0.3s ease;
        }

        @keyframes slideUp {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.3rem;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .close-modal:hover {
            background: #f0f0f0;
            color: #333;
        }

        /* Subtype Grid */
        .subtype-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 12px;
            margin: 20px 0;
        }

        .subtype-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            user-select: none;
        }

        .subtype-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border-color: var(--warning);
        }

        .subtype-card.selected {
            border-color: var(--warning);
            background: rgba(247, 37, 133, 0.08);
        }

        .subtype-icon {
            font-size: 1.8rem;
            margin-bottom: 10px;
            color: var(--warning);
        }

        .subtype-title {
            font-weight: 600;
            font-size: 0.9rem;
            color: #333;
        }

        /* Form Styles */
        .other-description-container {
            margin-top: 20px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border-left: 4px solid var(--warning);
            display: none;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
        }

        textarea, input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: var(--transition);
            font-size: 14px;
        }

        textarea:focus, input[type="text"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.1);
        }

        /* Current Scan Type Display */
        #current-scan-type {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 20px 0;
            text-align: center;
            animation: fadeIn 0.5s ease;
        }

        #current-scan-title {
            font-size: 1.3rem;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        #current-scan-description {
            opacity: 0.9;
            margin-bottom: 15px;
        }

        .time-remaining {
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 50px;
            display: inline-block;
            font-weight: 600;
            font-size: 0.9rem;
            backdrop-filter: blur(5px);
        }

        /* Camera Permission */
        #camera-permission {
            text-align: center;
            padding: 30px;
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin: 20px 0;
            border: 2px dashed #ddd;
        }

        .permission-btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: var(--border-radius);
            font-size: 16px;
            cursor: pointer;
            margin-top: 15px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .permission-btn:hover {
            background: var(--primary-dark);
            transform: translateY(-2px);
        }

        /* Scanner Container */
        #scanner-container {
            text-align: center;
            margin: 25px 0;
        }

        .scanner-frame {
            position: relative;
            display: inline-block;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.2);
            margin-bottom: 20px;
            background: #000;
        }

        video {
            width: 100%;
            max-width: 450px;
            height: 340px;
            background: #000;
            display: block;
            object-fit: cover;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .scanner-line {
            position: absolute;
            width: 100%;
            height: 4px;
            background: linear-gradient(to right, transparent, var(--primary), transparent);
            top: 10%;
            animation: scanLine 2s infinite linear;
            box-shadow: 0 0 10px rgba(67, 97, 238, 0.8);
        }

        @keyframes scanLine {
            0% { top: 10%; }
            50% { top: 90%; }
            100% { top: 10%; }
        }

        .scanner-corners {
            position: absolute;
            width: 100%;
            height: 100%;
        }

        .scanner-corners::before, .scanner-corners::after {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            border: 4px solid var(--primary);
        }

        .scanner-corners::before {
            top: 20px;
            left: 20px;
            border-right: none;
            border-bottom: none;
        }

        .scanner-corners::after {
            bottom: 20px;
            right: 20px;
            border-left: none;
            border-top: none;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 20px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px 20px;
            border-radius: var(--border-radius);
            text-align: center;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: bold;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Scan Count */
        .scan-count {
            background: var(--light);
            padding: 12px 24px;
            border-radius: 50px;
            display: inline-block;
            margin: 10px 0;
            font-weight: 700;
            color: var(--primary);
            border: 2px solid rgba(67, 97, 238, 0.2);
        }

        /* Button Grid */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        /* Message Styles */
        .message {
            padding: 20px;
            border-radius: var(--border-radius);
            margin: 15px 0;
            animation: fadeIn 0.5s ease;
        }

        .message-success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            border-left: 4px solid #28a745;
        }

        .message-error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }

        .message-info {
            background: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
            border-left: 4px solid #17a2b8;
        }

        .message-warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* Student List */
        .student-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
            border-radius: 8px;
            margin-bottom: 5px;
        }

        .student-item:hover {
            background: #f0f7ff;
            transform: translateX(5px);
        }

        .student-item:active {
            transform: translateX(0);
        }

        .student-item strong {
            display: block;
            margin-bottom: 5px;
            color: #333;
        }

        .student-item small {
            color: #666;
            font-size: 0.85rem;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-container {
                border-radius: 12px;
            }
            
            .content {
                padding: 20px;
            }
            
            .scan-type-grid {
                grid-template-columns: 1fr;
            }
            
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .subtype-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            video {
                max-width: 100%;
                height: 280px;
            }
            
            .header {
                padding: 20px;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .back-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
            }
            
            .subtype-grid {
                grid-template-columns: 1fr;
            }
            
            .modal-content {
                padding: 20px;
            }
            
            .stat-number {
                font-size: 1.8rem;
            }
            
            .scan-type-icon {
                font-size: 2rem;
            }
        }

        /* iOS Safe Areas */
        @supports (padding: max(0px)) {
            body {
                padding-left: max(10px, env(safe-area-inset-left));
                padding-right: max(10px, env(safe-area-inset-right));
                padding-top: max(10px, env(safe-area-inset-top));
                padding-bottom: max(10px, env(safe-area-inset-bottom));
            }
        }

        /* Scrollbar Styling */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 10px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Touch Device Optimizations */
        @media (hover: none) and (pointer: coarse) {
            .btn:hover, .scan-type-card:hover, .subtype-card:hover, .student-item:hover {
                transform: none;
            }
            
            .btn:active, .scan-type-card:active, .subtype-card:active, .student-item:active {
                opacity: 0.7;
            }
        }

        /* Print Styles */
        @media print {
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- ... keep all your existing HTML structure ... -->
    <!-- (HTML code remains exactly the same as before) -->

    <script>
        // ============================================
        // GLOBAL SCOPE CHECK
        // ============================================
        
        // Check if we're in a module or global scope
        (function() {
            console.log('üîÑ Starting application in isolated scope...');
            
            // ============================================
            // APPLICATION CONFIGURATION
            // ============================================
            
            // Supabase Configuration
            const SUPABASE_URL = 'https://ovvlshbuayykddqrnoqx.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dmxzaGJ1YXl5a2RkcXJub3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjQxODgsImV4cCI6MjA3NjM0MDE4OH0.vWLDFMS16PwZga9mYehVUiL6G0ccnRzdc9OUf2OM76I';
            
            // ============================================
            // GLOBAL STATE MANAGEMENT
            // ============================================
            
            // Use a unique namespace for our app
            if (!window.scanApp) {
                window.scanApp = {};
            }
            
            // Initialize Supabase with SAFE check
            let supabase;
            try {
                console.log('üîß Initializing Supabase...');
                
                if (window.supabase && typeof window.supabase.createClient === 'function') {
                    // Check if we already have a supabase instance
                    if (!window.scanApp.supabaseInstance) {
                        console.log('üì± Creating new Supabase client...');
                        window.scanApp.supabaseInstance = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                    } else {
                        console.log('‚ôªÔ∏è Reusing existing Supabase instance');
                    }
                    
                    supabase = window.scanApp.supabaseInstance;
                    console.log('‚úÖ Supabase initialized successfully');
                } else {
                    console.error('‚ùå Supabase library not available');
                    throw new Error('Supabase library not loaded');
                }
            } catch (error) {
                console.error('‚ùå Failed to initialize Supabase:', error);
                // Create a fallback supabase object
                supabase = {
                    from: () => ({
                        select: () => Promise.resolve({ data: [], error: null }),
                        insert: () => Promise.resolve({ data: [], error: error }),
                        eq: () => ({ select: () => Promise.resolve({ data: [], error: null }) }),
                        order: () => ({ limit: () => Promise.resolve({ data: [], error: null }) })
                    })
                };
                console.warn('‚ö†Ô∏è Using fallback Supabase object');
            }
            
            // ============================================
            // DOM ELEMENTS
            // ============================================
            
            const video = document.getElementById('camera');
            const resultDiv = document.getElementById('result');
            const scannerContainer = document.getElementById('scanner-container');
            const cameraPermissionDiv = document.getElementById('camera-permission');
            const scanCountDiv = document.getElementById('scan-count');
            const scannedCountSpan = document.getElementById('scanned-count');
            const startBtn = document.getElementById('start-btn');
            const stopBtn = document.getElementById('stop-btn');
            const todayScansElement = document.getElementById('today-scans');
            const totalStudentsElement = document.getElementById('total-students');
            const selectedTypeCountElement = document.getElementById('selected-type-count');
            const selectedTypeLabelElement = document.getElementById('selected-type-label');
            const currentScanTypeDiv = document.getElementById('current-scan-type');
            const currentScanTitle = document.getElementById('current-scan-title');
            const currentScanDescription = document.getElementById('current-scan-description');
            const timeLimitInfo = document.getElementById('time-limit-info');
            const manualEntryModal = document.getElementById('manualEntryModal');
            const studentList = document.getElementById('studentList');
            const studentSearch = document.getElementById('studentSearch');
            const disciplineSubtypesModal = document.getElementById('disciplineSubtypesModal');
            const otherDescriptionContainer = document.getElementById('otherDescriptionContainer');
            const otherDescription = document.getElementById('otherDescription');
            
            // ============================================
            // GLOBAL VARIABLES
            // ============================================
            
            let stream = null;
            let isScanning = false;
            let selectedScanType = null;
            let selectedDisciplineSubtype = null;
            let students = [];
            let scanAnimationFrame = null;
            const TIME_LIMIT_MINUTES = 10;
            const TIME_LIMIT_MS = TIME_LIMIT_MINUTES * 60 * 1000;
            
            // Device detection
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            const isIOS = /iPhone|iPad|iPod/i.test(navigator.userAgent);
            const isAndroid = /Android/i.test(navigator.userAgent);
            
            // ============================================
            // SCAN TYPES CONFIGURATION
            // ============================================
            
            const scanTypes = {
                late: {
                    title: "·ûü·û∑·ûü·üí·ûü·ûò·ûÄ·ûô·û∫·ûè",
                    description: "·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûò·ûÄ·ûô·û∫·ûè ·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûë·ûÑ·üã·ûá·û∂·ûè·û∑",
                    table: "attendance_reports"
                },
                discipline: {
                    title: "·ûü·û∑·ûü·üí·ûü·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô",
                    description: "·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô·ûü·û∂·ûõ·û∂",
                    table: "discipline_reports"
                },
                helpful: {
                    title: "·ûü·û∑·ûü·üí·ûü·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö",
                    description: "·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûî·û∂·ûì·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö·ûü·û∂·ûõ·û∂",
                    table: "helpful_reports"
                }
            };
            
            // ============================================
            // DISCIPLINE SUBTYPES CONFIGURATION
            // ============================================
            
            const disciplineSubtypes = {
                shoes: { title: "·ûü·üí·ûî·üÇ·ûÄ·ûá·ûæ·ûÑ", icon: "fas fa-shoe-prints" },
                uniform: { title: "·ûò·û∑·ûì·ûë·ûì·ûª·ûô", icon: "fas fa-tshirt" },
                canteen: { title: "·ûì·üÖ·ûö·üÑ·ûÑ·ûî·û∂·ûô·ûò·û∑·ûì·ûÖ·ûº·ûõ·ûê·üí·ûì·û∂·ûÄ·üã", icon: "fas fa-utensils" },
                fence: { title: "·ûï·üí·ûõ·üÑ·üá·ûö·ûî·ûÑ", icon: "fas fa-fence" },
                fight: { title: "·ûú·üâ·üÉ·ûÇ·üí·ûì·û∂", icon: "fas fa-fist-raised" },
                litter: { title: "·ûÖ·üÑ·ûõ·ûü·üÜ·ûö·û∂·ûò", icon: "fas fa-trash" },
                phone: { title: "·ûõ·üÅ·ûÑ·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë", icon: "fas fa-mobile-alt" },
                cuthuir2: { title: "·ûÄ·û∂·ûè·üã·ûü·ûÄ·üã", icon: "fas fa-cut" },
                escape: { title: "·ûÇ·üÅ·ûÖ·ûò·üâ·üÑ·ûÑ·ûö·üÄ·ûì", icon: "fas fa-running" },
                other: { title: "·ûï·üí·ûü·üÅ·ûÑ·üó", icon: "fas fa-ellipsis-h" }
            };
            
            // ============================================
            // INITIALIZATION FUNCTIONS
            // ============================================
            
            /**
             * Initialize the application
             */
            async function initApp() {
                console.log('üöÄ Starting app initialization...');
                console.log('Device:', isMobile ? 'Mobile' : 'Desktop');
                console.log('Platform:', isIOS ? 'iOS' : isAndroid ? 'Android' : 'Other');
                
                // Test camera capabilities
                await testCameraCapabilities();
                
                // Fetch students data
                await fetchStudents();
                
                // Update statistics
                await updateAllStats();
                
                // Test Supabase connection
                testSupabaseConnection();
                
                // Adjust UI for mobile devices
                if (isMobile) {
                    adjustUIForMobile();
                }
                
                // Add event listeners
                setupEventListeners();
                
                // Check login status
                checkLoginStatus();
            }
            
            /**
             * Test camera capabilities
             */
            async function testCameraCapabilities() {
                console.log('Testing camera capabilities...');
                
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('getUserMedia not supported');
                    showError('Browser ·ûì·üÅ·üá·ûò·û∑·ûì·ûÇ·û∂·üÜ·ûë·üí·ûö·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûë·üÅ·üî ·ûü·ûº·ûò·ûî·üí·ûö·ûæ Chrome ·û¨ Safari ·ûõ·ûæ·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë');
                    return false;
                }
                
                return true;
            }
            
            /**
             * Adjust UI for mobile devices
             */
            function adjustUIForMobile() {
                console.log('Adjusting UI for mobile...');
                
                // Make buttons larger for touch
                document.querySelectorAll('.btn').forEach(btn => {
                    btn.style.minHeight = '50px';
                    btn.style.fontSize = '16px';
                });
                
                // Adjust scanner size
                if (video) {
                    video.style.maxWidth = '100%';
                    video.style.maxHeight = '60vh';
                }
                
                // Update camera permission text
                const cameraPermissionText = document.querySelector('#camera-permission p');
                if (cameraPermissionText) {
                    cameraPermissionText.innerHTML = `
                        ·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûö·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûî·üí·ûö·ûæ·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûä·ûæ·ûò·üí·ûî·û∏·ûü·üí·ûÄ·üÅ·ûì QR Code<br>
                        <small style="color: #666; font-size: 0.9rem;">
                            ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë·üñ ·ûü·ûº·ûò·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûì·üÖ·ûñ·üÅ·ûõ·ûò·û∂·ûì·ûÄ·û∂·ûö·ûü·üí·ûì·ûæ·ûü·ûª·üÜ
                        </small>
                    `;
                }
            }
            
            /**
             * Set up event listeners
             */
            function setupEventListeners() {
                // Student search
                if (studentSearch) {
                    studentSearch.addEventListener('input', filterStudents);
                }
                
                // Keyboard shortcuts
                document.addEventListener('keydown', handleKeyboardShortcuts);
                
                // Page visibility changes
                document.addEventListener('visibilitychange', handleVisibilityChange);
                
                // Orientation changes (mobile)
                window.addEventListener('orientationchange', handleOrientationChange);
                
                // Page unload
                window.addEventListener('beforeunload', handlePageUnload);
                
                // Touch events for mobile
                if (isMobile) {
                    setupTouchEvents();
                }
            }
            
            /**
             * Check login status
             */
            function checkLoginStatus() {
                if (localStorage.getItem('adminLoggedIn') !== 'true') {
                    window.location.href = 'login.html';
                }
            }
            
            // ============================================
            // SCAN TYPE SELECTION FUNCTIONS
            // ============================================
            
            /**
             * Select scan type
             * @param {string} type - The scan type
             */
            function selectScanType(type) {
                console.log('Selected scan type:', type);
                
                // Update UI
                document.querySelectorAll('.scan-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-type="${type}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
                
                // Set selected type
                selectedScanType = type;
                selectedDisciplineSubtype = null; // Reset discipline subtype
                
                // Update display
                updateCurrentScanDisplay();
                
                // Enable start button
                if (startBtn) {
                    startBtn.disabled = false;
                }
                
                // Update statistics
                updateSelectedTypeStats();
            }
            
            /**
             * Open discipline subtypes modal
             */
            function openDisciplineSubtypes() {
                // Reset selection
                selectedDisciplineSubtype = null;
                document.querySelectorAll('.subtype-card').forEach(card => {
                    card.classList.remove('selected');
                });
                
                // Hide other description
                if (otherDescriptionContainer) {
                    otherDescriptionContainer.style.display = 'none';
                }
                if (otherDescription) {
                    otherDescription.value = '';
                }
                
                // Show modal
                if (disciplineSubtypesModal) {
                    disciplineSubtypesModal.style.display = 'flex';
                }
                
                // Prevent background scrolling on mobile
                if (isMobile) {
                    document.body.style.overflow = 'hidden';
                }
            }
            
            /**
             * Close discipline subtypes modal
             */
            function closeDisciplineSubtypes() {
                if (disciplineSubtypesModal) {
                    disciplineSubtypesModal.style.display = 'none';
                }
                
                // Reset main selection if no subtype was chosen
                if (!selectedDisciplineSubtype) {
                    document.querySelectorAll('.scan-type-card').forEach(card => {
                        card.classList.remove('selected');
                    });
                    selectedScanType = null;
                    if (startBtn) {
                        startBtn.disabled = true;
                    }
                }
                
                // Restore scrolling
                if (isMobile) {
                    document.body.style.overflow = 'auto';
                }
            }
            
            /**
             * Select discipline subtype
             * @param {string} subtype - The discipline subtype
             */
            function selectDisciplineSubtype(subtype) {
                // Update UI
                document.querySelectorAll('.subtype-card').forEach(card => {
                    card.classList.remove('selected');
                });
                const selectedCard = document.querySelector(`[data-subtype="${subtype}"]`);
                if (selectedCard) {
                    selectedCard.classList.add('selected');
                }
                
                selectedDisciplineSubtype = subtype;
                
                // Show/hide other description input
                if (otherDescriptionContainer) {
                    if (subtype === 'other') {
                        otherDescriptionContainer.style.display = 'block';
                        // Focus on textarea
                        setTimeout(() => {
                            if (otherDescription) {
                                otherDescription.focus();
                            }
                        }, 100);
                    } else {
                        otherDescriptionContainer.style.display = 'none';
                        if (otherDescription) {
                            otherDescription.value = '';
                        }
                    }
                }
            }
            
            /**
             * Confirm discipline subtype selection
             */
            function confirmDisciplineSubtype() {
                if (!selectedDisciplineSubtype) {
                    showError('‚ùó ·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô');
                    return;
                }
                
                // For "other" subtype, check description
                if (selectedDisciplineSubtype === 'other' && otherDescription && !otherDescription.value.trim()) {
                    showError('‚ùó ·ûü·ûº·ûò·ûü·ûö·ûü·üÅ·ûö·ûî·ûâ·üí·ûá·û∂·ûÄ·üã·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô');
                    return;
                }
                
                // Set main scan type
                selectedScanType = 'discipline';
                
                // Update main UI
                document.querySelectorAll('.scan-type-card').forEach(card => {
                    card.classList.remove('selected');
                });
                const disciplineCard = document.querySelector('[data-type="discipline"]');
                if (disciplineCard) {
                    disciplineCard.classList.add('selected');
                }
                
                // Update display
                updateCurrentScanDisplay();
                
                // Enable start button
                if (startBtn) {
                    startBtn.disabled = false;
                }
                
                // Close modal
                closeDisciplineSubtypes();
                
                // Update statistics
                updateSelectedTypeStats();
                
                console.log(`‚úÖ Selected discipline subtype: ${selectedDisciplineSubtype}`);
            }
            
            /**
             * Update current scan display
             */
            function updateCurrentScanDisplay() {
                if (!currentScanTitle || !currentScanDescription || !currentScanTypeDiv || !timeLimitInfo) {
                    return;
                }
                
                let displayTitle = scanTypes[selectedScanType]?.title || '';
                let displayDescription = scanTypes[selectedScanType]?.description || '';
                
                // Add discipline subtype info
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    let subtypeTitle = disciplineSubtypes[selectedDisciplineSubtype]?.title || '';
                    
                    // Use custom description for "other" subtype
                    if (selectedDisciplineSubtype === 'other' && otherDescription && otherDescription.value.trim()) {
                        subtypeTitle = otherDescription.value.trim();
                    }
                    
                    displayTitle += ` - ${subtypeTitle}`;
                    displayDescription = `·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ${subtypeTitle}`;
                }
                
                currentScanTitle.textContent = `·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûÄ·üÅ·ûì: ${displayTitle}`;
                currentScanDescription.textContent = displayDescription;
                currentScanTypeDiv.style.display = 'block';
                timeLimitInfo.style.display = 'block';
            }
            
            // ============================================
            // CAMERA AND SCANNING FUNCTIONS
            // ============================================
            
            /**
             * Request camera permission
             */
            async function requestCameraPermission() {
                console.log('Requesting camera permission...');
                
                try {
                    if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                        showError('Browser ·ûì·üÅ·üá·ûò·û∑·ûì·ûÇ·û∂·üÜ·ûë·üí·ûö·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûë·üÅ·üî ·ûü·ûº·ûò·ûî·üí·ûö·ûæ Chrome ·û¨ Safari ·ûõ·ûæ·ûë·ûº·ûö·ûü·üê·ûñ·üí·ûë');
                        return;
                    }
                    
                    // Camera constraints
                    const constraints = {
                        video: {
                            facingMode: "environment",
                            width: { ideal: isMobile ? 1280 : 1920 },
                            height: { ideal: isMobile ? 720 : 1080 }
                        },
                        audio: false
                    };
                    
                    // iOS-specific constraints
                    if (isIOS) {
                        constraints.video = {
                            facingMode: { exact: "environment" },
                            width: { min: 640, ideal: 1280, max: 1920 },
                            height: { min: 480, ideal: 720, max: 1080 }
                        };
                    }
                    
                    // Request camera access
                    stream = await navigator.mediaDevices.getUserMedia(constraints);
                    
                    // Update UI
                    if (cameraPermissionDiv) {
                        cameraPermissionDiv.style.display = 'none';
                    }
                    showSuccess('‚úÖ ·ûî·û∂·ûì·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã');
                    
                } catch (error) {
                    console.error('Camera error:', error);
                    handleCameraError(error);
                }
            }
            
            /**
             * Handle camera errors
             * @param {Error} error - The error object
             */
            function handleCameraError(error) {
                let errorMessage = '·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·ûæ·ûÄ·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûî·û∂·ûì·üî ';
                
                if (error.name === 'NotAllowedError') {
                    errorMessage += '·ûü·ûº·ûò·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·û∂·ûö·ûÄ·üÜ·ûé·ûè·üã browser';
                } else if (error.name === 'NotFoundError') {
                    errorMessage += '·ûò·û∑·ûì·ûò·û∂·ûì·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûë·üÅ';
                } else if (error.name === 'NotSupportedError') {
                    errorMessage += 'Browser ·ûò·û∑·ûì·ûÇ·û∂·üÜ·ûë·üí·ûö·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûë·üÅ';
                } else if (error.name === 'NotReadableError') {
                    errorMessage += '·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûÄ·üÜ·ûñ·ûª·ûÑ·ûî·üí·ûö·ûæ·ûä·üÑ·ûô·ûÄ·ûò·üí·ûò·ûú·û∑·ûí·û∏·ûï·üí·ûü·üÅ·ûÑ';
                } else if (error.name === 'OverconstrainedError') {
                    errorMessage += '·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·üÜ·ûñ·üÅ·ûâ·ûè·ûò·üí·ûö·ûº·ûú·ûÄ·û∂·ûö·ûë·üÅ';
                } else {
                    errorMessage += '·ûü·ûº·ûò·ûñ·û∑·ûì·û∑·ûè·üí·ûô·û¢·ûì·ûª·ûâ·üí·ûâ·û∂·ûè·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂';
                }
                
                showError(errorMessage);
                
                // Show manual entry option
                if (resultDiv) {
                    resultDiv.innerHTML += `
                        <div class="message message-info" style="margin-top: 10px;">
                            <p>·û¨·û¢·üí·ûì·ûÄ·û¢·û∂·ûÖ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûü·û∑·ûü·üí·ûü·ûè·û∂·ûò·û¢·ûè·üí·ûè·ûõ·üÅ·ûÅ·üñ</p>
                            <button class="btn btn-primary" onclick="window.scanApp.openManualEntryModal()" style="margin-top: 10px;">
                                <i class="fas fa-keyboard"></i> ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûè·û∂·ûò·û¢·ûè·üí·ûè·ûõ·üÅ·ûÅ
                            </button>
                        </div>
                    `;
                }
            }
            
            /**
             * Start camera
             */
            function startCamera() {
                if (!selectedScanType) {
                    showError('‚ùó ·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûü·û∑·ûü·üí·ûü·ûò·ûª·ûì·ûñ·üÅ·ûõ·ûü·üí·ûÄ·üÅ·ûì');
                    return;
                }
                
                // Check discipline subtype
                if (selectedScanType === 'discipline' && !selectedDisciplineSubtype) {
                    showError('‚ùó ·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô');
                    openDisciplineSubtypes();
                    return;
                }
                
                if (!stream) {
                    requestCameraPermission();
                    return;
                }
                
                // Set up video element
                if (video) {
                    video.srcObject = stream;
                    video.setAttribute('playsinline', 'true');
                    video.setAttribute('webkit-playsinline', 'true');
                }
                
                // Update UI
                if (scannerContainer) scannerContainer.style.display = 'block';
                if (scanCountDiv) scanCountDiv.style.display = 'block';
                if (startBtn) startBtn.disabled = true;
                if (stopBtn) stopBtn.disabled = false;
                
                // Start video playback
                if (video) {
                    video.play().then(() => {
                        startQRScanning();
                    }).catch(err => {
                        console.error('Video play error:', err);
                        handleVideoPlayError(err);
                    });
                }
            }
            
            /**
             * Handle video play errors
             * @param {Error} err - The error object
             */
            function handleVideoPlayError(err) {
                showError('·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·ûæ·ûÄ·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûî·û∂·ûì: ' + err.message);
                
                // Try alternative approach for iOS
                if (isIOS && video) {
                    video.muted = true;
                    video.play().then(() => {
                        startQRScanning();
                    }).catch(err2 => {
                        showError('·ûò·û∑·ûì·û¢·û∂·ûÖ·ûî·ûæ·ûÄ·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûõ·ûæ iOS: ' + err2.message);
                    });
                }
            }
            
            /**
             * Start QR scanning
             */
            function startQRScanning() {
                isScanning = true;
                let scanTypeText = scanTypes[selectedScanType]?.title || '';
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    scanTypeText += ` - ${disciplineSubtypes[selectedDisciplineSubtype]?.title || ''}`;
                }
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="message message-info"><i class="fas fa-qrcode"></i> ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûÄ·üÅ·ûì QR code ·ûü·ûò·üí·ûö·û∂·ûî·üã ${scanTypeText}...</div>`;
                }
                scanFrame();
            }
            
            /**
             * Scan frame for QR codes
             */
            function scanFrame() {
                if (!isScanning || !video) return;
                
                if (video.readyState === video.HAVE_ENOUGH_DATA) {
                    // Create canvas for image processing
                    const canvas = document.createElement('canvas');
                    const context = canvas.getContext('2d');
                    
                    // Set canvas size (smaller on mobile for performance)
                    if (isMobile) {
                        canvas.width = 320;
                        canvas.height = 240;
                    } else {
                        canvas.width = video.videoWidth;
                        canvas.height = video.videoHeight;
                    }
                    
                    // Draw video frame to canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Scan for QR code
                    const code = jsQR(imageData.data, imageData.width, imageData.height);
                    
                    if (code) {
                        handleScannedQR(code.data);
                        return;
                    }
                }
                
                // Continue scanning
                if (isScanning) {
                    // Adjust frame rate for mobile
                    if (isMobile) {
                        setTimeout(() => {
                            scanAnimationFrame = requestAnimationFrame(scanFrame);
                        }, 100);
                    } else {
                        scanAnimationFrame = requestAnimationFrame(scanFrame);
                    }
                }
            }
            
            /**
             * Handle scanned QR code
             * @param {string} qrData - The QR code data
             */
            async function handleScannedQR(qrData) {
                console.log('QR Scanned:', qrData);
                
                // Stop scanning temporarily
                isScanning = false;
                if (scanAnimationFrame) {
                    cancelAnimationFrame(scanAnimationFrame);
                }
                
                // Extract student ID
                let studentId = qrData;
                if (qrData.includes('?')) {
                    try {
                        const url = new URL(qrData);
                        studentId = url.searchParams.get('id') || qrData;
                    } catch (e) {
                        // Not a URL
                    }
                }
                
                // Find student
                const student = students.find(s => s.id === studentId || s.qr_code === qrData);
                
                if (student) {
                    // Check time limit
                    const timeCheckResult = await checkStudentScanTimeLimit(student.id);
                    if (timeCheckResult.withinLimit) {
                        const remainingMinutes = Math.ceil(timeCheckResult.remainingTime / 60000);
                        showWarning(`‚ö†Ô∏è ·ûü·û∑·ûü·üí·ûü ${student.name} ·ûî·û∂·ûì·ûü·üí·ûÄ·üÅ·ûì${scanTypes[selectedScanType]?.title || ''}·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã<br><br>·ûü·ûº·ûò·ûö·ûÑ·üã·ûÖ·û∂·üÜ ${remainingMinutes} ·ûì·û∂·ûë·û∏·ûë·üÄ·ûè·ûò·ûª·ûì·ûñ·üÅ·ûõ·ûü·üí·ûÄ·üÅ·ûì·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè`);
                        setTimeout(() => restartScanning(), 3000);
                    } else {
                        await recordStudent(student);
                    }
                } else {
                    showError('‚ùå ·ûò·û∑·ûì·ûò·û∂·ûì·ûü·û∑·ûü·üí·ûü·ûì·üÖ·ûÄ·üí·ûì·ûª·ûÑ·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí: ' + studentId);
                    setTimeout(() => restartScanning(), 2000);
                }
            }
            
            /**
             * Check student scan time limit
             * @param {string} studentId - The student ID
             * @returns {Object} Time limit check result
             */
            async function checkStudentScanTimeLimit(studentId) {
                try {
                    const tableName = scanTypes[selectedScanType]?.table;
                    
                    if (!tableName) {
                        return { withinLimit: false, remainingTime: 0 };
                    }
                    
                    console.log(`üîç Checking ${selectedScanType} scan for student ${studentId}`);
                    
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('timestamp')
                        .eq('student_id', studentId)
                        .order('timestamp', { ascending: false })
                        .limit(1);
                    
                    if (error) {
                        console.error('Error checking scan time:', error);
                        return { withinLimit: false, remainingTime: 0 };
                    }
                    
                    if (!data || data.length === 0) {
                        return { withinLimit: false, remainingTime: 0 };
                    }
                    
                    const lastScanTime = new Date(data[0].timestamp).getTime();
                    const currentTime = new Date().getTime();
                    const timeDiff = currentTime - lastScanTime;
                    const remainingTime = TIME_LIMIT_MS - timeDiff;
                    
                    console.log(`Time since last scan: ${Math.floor(timeDiff/1000/60)} minutes`);
                    
                    return {
                        withinLimit: timeDiff < TIME_LIMIT_MS,
                        remainingTime: remainingTime > 0 ? remainingTime : 0
                    };
                    
                } catch (error) {
                    console.error('Error checking student scan time limit:', error);
                    return { withinLimit: false, remainingTime: 0 };
                }
            }
            
            /**
             * Restart scanning
             */
            function restartScanning() {
                isScanning = true;
                let scanTypeText = scanTypes[selectedScanType]?.title || '';
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    scanTypeText += ` - ${disciplineSubtypes[selectedDisciplineSubtype]?.title || ''}`;
                }
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="message message-info"><i class="fas fa-qrcode"></i> ·ûÄ·üÜ·ûñ·ûª·ûÑ·ûü·üí·ûÄ·üÅ·ûì QR code ·ûü·ûò·üí·ûö·û∂·ûî·üã ${scanTypeText}... ·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü·ûî·ûì·üí·ûë·û∂·ûî·üã</div>`;
                }
                
                if (isMobile) {
                    setTimeout(() => {
                        scanAnimationFrame = requestAnimationFrame(scanFrame);
                    }, 100);
                } else {
                    scanAnimationFrame = requestAnimationFrame(scanFrame);
                }
            }
            
            /**
             * Stop camera
             */
            function stopCamera() {
                isScanning = false;
                if (scanAnimationFrame) {
                    cancelAnimationFrame(scanAnimationFrame);
                }
                
                if (stream) {
                    stream.getTracks().forEach(track => track.stop());
                    stream = null;
                }
                
                // Update UI
                if (scannerContainer) scannerContainer.style.display = 'none';
                if (scanCountDiv) scanCountDiv.style.display = 'none';
                if (cameraPermissionDiv) cameraPermissionDiv.style.display = 'block';
                if (startBtn) startBtn.disabled = false;
                if (stopBtn) stopBtn.disabled = true;
                
                if (resultDiv) {
                    resultDiv.innerHTML = '<div class="message message-info"><i class="fas fa-camera"></i> ·ûÄ·û∂·ûò·üÅ·ûö·üâ·û∂·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûî·û∑·ûë·üî ·ûÖ·ûª·ûÖ "·ûÖ·û∂·ûî·üã·ûï·üí·ûä·ûæ·ûò·ûü·üí·ûÄ·üÅ·ûì" ·ûä·ûæ·ûò·üí·ûî·û∏·ûî·ûæ·ûÄ·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè</div>';
                }
            }
            
            // ============================================
            // STUDENT RECORDING FUNCTIONS
            // ============================================
            
            /**
             * Record student
             * @param {Object} student - The student object
             */
            async function recordStudent(student) {
                const now = new Date();
                const record = {
                    student_id: student.id,
                    name: student.name,
                    class: student.class,
                    gender: student.gender || '·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô',
                    scan_time: now.toTimeString().split(' ')[0],
                    date: now.toISOString().split('T')[0],
                    timestamp: now.toISOString(),
                    scan_type: selectedScanType
                };
                
                // Add discipline subtype info
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    record.discipline_subtype = selectedDisciplineSubtype;
                    
                    if (selectedDisciplineSubtype === 'other' && otherDescription && otherDescription.value.trim()) {
                        record.discipline_description = otherDescription.value.trim();
                    } else {
                        record.discipline_description = disciplineSubtypes[selectedDisciplineSubtype]?.title || '';
                    }
                }
                
                try {
                    const tableName = scanTypes[selectedScanType]?.table;
                    if (!tableName) {
                        throw new Error('Table name not found');
                    }
                    
                    console.log(`üíæ Saving to Supabase: ${tableName}`);
                    
                    const { data, error } = await supabase
                        .from(tableName)
                        .insert([record])
                        .select();
                    
                    if (error) {
                        console.error('‚ùå Supabase error:', error);
                        
                        if (error.message.includes('row-level security policy')) {
                            showError('·ûÄ·üÜ·û†·ûª·ûü·ûü·ûª·ûú·ûè·üí·ûê·û∑·ûó·û∂·ûñ·üñ ·ûò·û∑·ûì·ûò·û∂·ûì·ûü·û∑·ûë·üí·ûí·û∑·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô');
                            await tryAlternativeTable(record);
                        } else {
                            throw error;
                        }
                    } else {
                        console.log('‚úÖ Successfully saved to Supabase:', data);
                        
                        // Save to localStorage as backup
                        saveToLocalStorage(record);
                        
                        // Show success message
                        showSuccessMessage(record, student, tableName);
                        
                        // Update statistics
                        await updateAllStats();
                    }
                    
                } catch (error) {
                    console.error('‚ùå Error saving to Supabase:', error);
                    
                    // Fallback to localStorage
                    saveToLocalStorage(record);
                    
                    // Show success message with warning
                    showLocalSuccessMessage(record, student, error);
                    
                    // Update statistics
                    await updateAllStats();
                }
                
                // Restart scanning
                setTimeout(() => restartScanning(), 2000);
            }
            
            /**
             * Show success message
             */
            function showSuccessMessage(record, student, tableName) {
                let successMessage = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="font-size: 2rem; color: #28a745;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <strong style="font-size: 1.1rem;">‚úÖ ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûî·û∂·ûì·ûá·üÑ·ûÇ!</strong><br>
                            <strong>·ûî·üí·ûö·ûó·üÅ·ûë:</strong> ${scanTypes[selectedScanType]?.title || ''}<br>
                            <strong>·ûà·üí·ûò·üÑ·üá:</strong> ${student.name}<br>
                            <strong>·ûê·üí·ûì·û∂·ûÄ·üã:</strong> ${student.class}<br>
                            <strong>·ûñ·üÅ·ûõ·ûú·üÅ·ûõ·û∂:</strong> ${record.scan_time}<br>
                `;
                
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    successMessage += `<strong>·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô:</strong> ${record.discipline_description}<br>`;
                }
                
                successMessage += `<strong>·ûè·û∂·ûö·û∂·ûÑ:</strong> ${tableName}<br>`;
                successMessage += `<em style="font-size: 0.9rem; color: #666;">·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûÄ·üí·ûì·ûª·ûÑ·ûî·üí·ûö·ûñ·üê·ûì·üí·ûí!</em>
                        </div>
                    </div>`;
                
                // Vibrate on mobile
                if (isMobile && navigator.vibrate) {
                    navigator.vibrate(200);
                }
                
                showSuccess(successMessage);
            }
            
            /**
             * Show local success message
             */
            function showLocalSuccessMessage(record, student, error) {
                let successMessage = `
                    <div style="display: flex; align-items: flex-start; gap: 15px;">
                        <div style="font-size: 2rem; color: #28a745;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <div>
                            <strong style="font-size: 1.1rem;">‚úÖ ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûî·û∂·ûì·ûá·üÑ·ûÇ! (Local)</strong><br>
                            <strong>·ûî·üí·ûö·ûó·üÅ·ûë:</strong> ${scanTypes[selectedScanType]?.title || ''}<br>
                            <strong>·ûà·üí·ûò·üÑ·üá:</strong> ${student.name}<br>
                            <strong>·ûê·üí·ûì·û∂·ûÄ·üã:</strong> ${student.class}<br>
                            <strong>·ûñ·üÅ·ûõ·ûú·üÅ·ûõ·û∂:</strong> ${record.scan_time}<br>
                `;
                
                if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                    successMessage += `<strong>·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô:</strong> ${record.discipline_description}<br>`;
                }
                
                successMessage += `<p class="message message-warning" style="margin-top: 10px; padding: 10px;">
                                    <i class="fas fa-exclamation-triangle"></i> ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûè·üí·ûö·ûº·ûú·ûî·û∂·ûì·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûè·üÇ·ûÄ·üí·ûì·ûª·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç·ûî·üâ·ûª·ûé·üí·ûé·üÑ·üá
                                  </p>`;
                successMessage += `<small style="color: #999;">·ûÄ·üÜ·û†·ûª·ûü: ${error.message}</small>
                        </div>
                    </div>`;
                
                showSuccess(successMessage);
            }
            
            /**
             * Try alternative table
             * @param {Object} record - The record to save
             */
            async function tryAlternativeTable(record) {
                try {
                    const { data, error } = await supabase
                        .from('student_reports')
                        .insert([record])
                        .select();
                    
                    if (error) throw error;
                    
                    console.log('‚úÖ Saved to alternative table:', data);
                    
                    showSuccess('‚úÖ ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûî·û∂·ûì·ûá·üÑ·ûÇ! (·ûè·û∂·ûö·û∂·ûÑ·ûá·üÜ·ûì·ûΩ·ûü)');
                    
                } catch (altError) {
                    console.error('‚ùå Error saving to alternative table:', altError);
                    throw altError;
                }
            }
            
            /**
             * Save to localStorage
             * @param {Object} record - The record to save
             */
            function saveToLocalStorage(record) {
                const key = `${selectedScanType}Reports`;
                const existing = JSON.parse(localStorage.getItem(key) || '[]');
                const localRecord = {
                    ...record,
                    date: new Date().toDateString(),
                    timestamp: new Date().getTime()
                };
                existing.push(localRecord);
                localStorage.setItem(key, JSON.stringify(existing));
                console.log(`üíæ Saved to localStorage: ${key}`);
            }
            
            // ============================================
            // DATA FUNCTIONS
            // ============================================
            
            /**
             * Fetch students from Supabase
             */
            async function fetchStudents() {
                try {
                    console.log('Fetching students...');
                    
                    const { data, error } = await supabase
                        .from('students')
                        .select('*')
                        .limit(1000);
                    
                    if (error) throw error;
                    
                    students = data || [];
                    if (totalStudentsElement) {
                        totalStudentsElement.textContent = students.length;
                    }
                    console.log(`Fetched ${students.length} students`);
                    
                } catch (error) {
                    console.error('Error fetching students:', error);
                    students = [];
                    showError('‚ö†Ô∏è ·ûò·û∑·ûì·û¢·û∂·ûÖ·ûë·û∂·ûâ·ûô·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü·ûî·û∂·ûì');
                }
            }
            
            /**
             * Update all statistics
             */
            async function updateAllStats() {
                await updateScanCount();
                await updateSelectedTypeStats();
                updateScannedCount();
            }
            
            /**
             * Update scan count
             */
            async function updateScanCount() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    let totalScans = 0;
                    
                    for (const type in scanTypes) {
                        const tableName = scanTypes[type].table;
                        try {
                            const { data, error } = await supabase
                                .from(tableName)
                                .select('*', { count: 'exact' })
                                .eq('date', today);
                            
                            if (!error && data) {
                                totalScans += data.length;
                            }
                        } catch (tableError) {
                            console.warn(`‚ö†Ô∏è Could not access table ${tableName}:`, tableError);
                        }
                    }
                    
                    if (todayScansElement) {
                        todayScansElement.textContent = totalScans;
                    }
                    console.log(`üìà Total scans today: ${totalScans}`);
                    
                } catch (error) {
                    console.error('Error updating scan count:', error);
                    // Fallback to localStorage
                    let totalScans = 0;
                    for (const type in scanTypes) {
                        const key = `${type}Reports`;
                        const reports = JSON.parse(localStorage.getItem(key) || '[]');
                        const today = new Date().toDateString();
                        const todayScans = reports.filter(report => report.date === today);
                        totalScans += todayScans.length;
                    }
                    if (todayScansElement) {
                        todayScansElement.textContent = totalScans;
                    }
                }
            }
            
            /**
             * Update selected type statistics
             */
            async function updateSelectedTypeStats() {
                if (!selectedScanType) return;
                
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const tableName = scanTypes[selectedScanType].table;
                    
                    const { data, error } = await supabase
                        .from(tableName)
                        .select('*', { count: 'exact' })
                        .eq('date', today);
                    
                    if (!error && selectedTypeCountElement && selectedTypeLabelElement) {
                        selectedTypeCountElement.textContent = data.length;
                        let label = scanTypes[selectedScanType].title + ' ·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá';
                        if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                            label = disciplineSubtypes[selectedDisciplineSubtype].title + ' ·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá';
                        }
                        selectedTypeLabelElement.textContent = label;
                    }
                } catch (error) {
                    console.error('Error updating selected type stats:', error);
                    // Fallback to localStorage
                    const key = `${selectedScanType}Reports`;
                    const reports = JSON.parse(localStorage.getItem(key) || '[]');
                    const today = new Date().toDateString();
                    const todayScans = reports.filter(report => report.date === today);
                    if (selectedTypeCountElement && selectedTypeLabelElement) {
                        selectedTypeCountElement.textContent = todayScans.length;
                        let label = scanTypes[selectedScanType].title + ' ·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá';
                        if (selectedScanType === 'discipline' && selectedDisciplineSubtype) {
                            label = disciplineSubtypes[selectedDisciplineSubtype].title + ' ·ûê·üí·ûÑ·üÉ·ûì·üÅ·üá';
                        }
                        selectedTypeLabelElement.textContent = label;
                    }
                }
            }
            
            /**
             * Update scanned count display
             */
            function updateScannedCount() {
                if (!selectedScanType || !scannedCountSpan) return;
                
                const key = `${selectedScanType}Reports`;
                const reports = JSON.parse(localStorage.getItem(key) || '[]');
                const today = new Date().toDateString();
                const todayScans = reports.filter(report => report.date === today);
                scannedCountSpan.textContent = todayScans.length;
            }
            
            /**
             * Test Supabase connection
             */
            async function testSupabaseConnection() {
                try {
                    console.log('üîó Testing Supabase connection...');
                    
                    const { data, error } = await supabase
                        .from('students')
                        .select('*')
                        .limit(1);
                    
                    if (error) {
                        console.warn('‚ùå Supabase connection failed:', error);
                        showError('‚ö†Ô∏è ·ûÄ·û∂·ûö·ûè·ûó·üí·ûá·û∂·ûî·üã Supabase ·ûò·û∂·ûì·ûî·ûâ·üí·û†·û∂·üî ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûì·ûπ·ûÑ·ûè·üí·ûö·ûº·ûú·ûö·ûÄ·üí·ûü·û∂·ûë·ûª·ûÄ·ûÄ·üí·ûì·ûª·ûÑ·ûß·ûî·ûÄ·ûö·ûé·üç');
                    } else {
                        console.log('‚úÖ Supabase connection successful');
                    }
                    
                } catch (error) {
                    console.warn('Supabase connection test failed:', error);
                }
            }
            
            // ============================================
            // MANUAL ENTRY FUNCTIONS
            // ============================================
            
            /**
             * Open manual entry modal
             */
            function openManualEntryModal() {
                if (!selectedScanType) {
                    showError('‚ùó ·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûü·û∑·ûü·üí·ûü·ûò·ûª·ûì·ûñ·üÅ·ûõ·ûÄ·ûè·üã·ûè·üí·ûö·û∂·ûè·û∂·ûò·û¢·ûè·üí·ûè·ûõ·üÅ·ûÅ');
                    return;
                }
                
                // Check discipline subtype
                if (selectedScanType === 'discipline' && !selectedDisciplineSubtype) {
                    showError('‚ùó ·ûü·ûº·ûò·ûá·üí·ûö·ûæ·ûü·ûö·ûæ·ûü·ûî·üí·ûö·ûó·üÅ·ûë·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô');
                    openDisciplineSubtypes();
                    return;
                }
                
                // Populate student list
                populateStudentList();
                
                // Show modal
                if (manualEntryModal) {
                    manualEntryModal.style.display = 'flex';
                }
                
                // Prevent background scrolling on mobile
                if (isMobile) {
                    document.body.style.overflow = 'hidden';
                }
                
                // Focus on search input
                setTimeout(() => {
                    if (studentSearch) {
                        studentSearch.focus();
                    }
                }, 100);
            }
            
            /**
             * Close manual entry modal
             */
            function closeManualEntryModal() {
                if (manualEntryModal) {
                    manualEntryModal.style.display = 'none';
                }
                if (studentSearch) {
                    studentSearch.value = '';
                }
                
                // Restore scrolling
                if (isMobile) {
                    document.body.style.overflow = 'auto';
                }
            }
            
            /**
             * Populate student list
             */
            function populateStudentList() {
                if (!studentList) return;
                
                studentList.innerHTML = '';
                
                if (students.length === 0) {
                    studentList.innerHTML = '<div class="message message-warning" style="padding: 15px; text-align: center;"><i class="fas fa-users"></i> ·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô·ûü·û∑·ûü·üí·ûü</div>';
                    return;
                }
                
                // Sort students by name
                const sortedStudents = [...students].sort((a, b) => a.name.localeCompare(b.name));
                
                sortedStudents.forEach(student => {
                    const studentItem = document.createElement('div');
                    studentItem.className = 'student-item';
                    studentItem.onclick = () => selectStudent(student);
                    
                    studentItem.innerHTML = `
                        <strong>${student.name}</strong><br>
                        <small><i class="fas fa-id-card"></i> ·û¢·ûè·üí·ûè·ûõ·üÅ·ûÅ: ${student.id} | <i class="fas fa-graduation-cap"></i> ·ûê·üí·ûì·û∂·ûÄ·üã: ${student.class}</small>
                    `;
                    
                    studentList.appendChild(studentItem);
                });
            }
            
            /**
             * Filter students
             */
            function filterStudents() {
                const searchTerm = studentSearch.value.toLowerCase();
                const studentItems = studentList.getElementsByClassName('student-item');
                
                for (let i = 0; i < studentItems.length; i++) {
                    const studentText = studentItems[i].textContent.toLowerCase();
                    if (studentText.includes(searchTerm)) {
                        studentItems[i].style.display = 'block';
                    } else {
                        studentItems[i].style.display = 'none';
                    }
                }
            }
            
            /**
             * Select student
             * @param {Object} student - The student object
             */
            async function selectStudent(student) {
                closeManualEntryModal();
                
                // Check time limit
                const timeCheckResult = await checkStudentScanTimeLimit(student.id);
                if (timeCheckResult.withinLimit) {
                    const remainingMinutes = Math.ceil(timeCheckResult.remainingTime / 60000);
                    showWarning(`<i class="fas fa-clock"></i> ‚ö†Ô∏è ·ûü·û∑·ûü·üí·ûü ${student.name} ·ûî·û∂·ûì·ûü·üí·ûÄ·üÅ·ûì${scanTypes[selectedScanType]?.title || ''}·ûö·ûΩ·ûÖ·ûö·û∂·ûõ·üã<br><br>·ûü·ûº·ûò·ûö·ûÑ·üã·ûÖ·û∂·üÜ ${remainingMinutes} ·ûì·û∂·ûë·û∏·ûë·üÄ·ûè·ûò·ûª·ûì·ûñ·üÅ·ûõ·ûü·üí·ûÄ·üÅ·ûì·ûò·üí·ûè·ûÑ·ûë·üÄ·ûè`);
                } else {
                    await recordStudent(student);
                }
            }
            
            // ============================================
            // UTILITY FUNCTIONS
            // ============================================
            
            /**
             * Show success message
             * @param {string} message - The message to show
             */
            function showSuccess(message) {
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="message message-success">${message}</div>`;
                }
            }
            
            /**
             * Show error message
             * @param {string} message - The message to show
             */
            function showError(message) {
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="message message-error"><i class="fas fa-exclamation-circle"></i> ${message}</div>`;
                }
            }
            
            /**
             * Show warning message
             * @param {string} message - The message to show
             */
            function showWarning(message) {
                if (resultDiv) {
                    resultDiv.innerHTML = `<div class="message message-warning"><i class="fas fa-exclamation-triangle"></i> ${message}</div>`;
                }
            }
            
            /**
             * Go to home page
             */
            function goToHome() {
                window.location.href = 'index.html';
            }
            
            /**
             * Go back
             */
            function goBack() {
                window.history.back();
            }
            
            /**
             * View reports
             */
            function viewReports() {
                window.location.href = 'list.html';
            }
            
            // ============================================
            // EVENT HANDLERS
            // ============================================
            
            /**
             * Handle keyboard shortcuts
             * @param {Event} e - The keyboard event
             */
            function handleKeyboardShortcuts(e) {
                // ESC to close modals
                if (e.key === 'Escape') {
                    if (disciplineSubtypesModal && disciplineSubtypesModal.style.display === 'flex') {
                        closeDisciplineSubtypes();
                    }
                    if (manualEntryModal && manualEntryModal.style.display === 'flex') {
                        closeManualEntryModal();
                    }
                }
                
                // Space to start/stop scanning
                if (e.key === ' ' && !e.target.matches('input, textarea')) {
                    e.preventDefault();
                    if (isScanning) {
                        stopCamera();
                    } else if (startBtn && !startBtn.disabled) {
                        startCamera();
                    }
                }
            }
            
            /**
             * Handle visibility change
             */
            function handleVisibilityChange() {
                if (document.hidden && isScanning) {
                    console.log('Page hidden, stopping camera');
                    stopCamera();
                }
            }
            
            /**
             * Handle orientation change
             */
            function handleOrientationChange() {
                console.log('Orientation changed');
                
                // Restart camera if it was running
                if (isScanning && stream) {
                    setTimeout(() => {
                        if (video && video.srcObject) {
                            video.play().catch(err => {
                                console.error('Error restarting video:', err);
                            });
                        }
                    }, 300);
                }
            }
            
            /**
             * Handle page unload
             */
            function handlePageUnload() {
                if (isScanning) {
                    stopCamera();
                }
            }
            
            /**
             * Set up touch events
             */
            function setupTouchEvents() {
                // Prevent zoom on double tap
                document.addEventListener('touchstart', function(event) {
                    if (event.touches.length > 1) {
                        event.preventDefault();
                    }
                }, { passive: false });
                
                let lastTouchEnd = 0;
                document.addEventListener('touchend', function(event) {
                    const now = (new Date()).getTime();
                    if (now - lastTouchEnd <= 300) {
                        event.preventDefault();
                    }
                    lastTouchEnd = now;
                }, false);
            }
            
            // ============================================
            // EXPOSE FUNCTIONS TO GLOBAL SCOPE
            // ============================================
            
            // Store functions in the scanApp namespace
            window.scanApp.selectScanType = selectScanType;
            window.scanApp.openDisciplineSubtypes = openDisciplineSubtypes;
            window.scanApp.closeDisciplineSubtypes = closeDisciplineSubtypes;
            window.scanApp.selectDisciplineSubtype = selectDisciplineSubtype;
            window.scanApp.confirmDisciplineSubtype = confirmDisciplineSubtype;
            window.scanApp.requestCameraPermission = requestCameraPermission;
            window.scanApp.startCamera = startCamera;
            window.scanApp.stopCamera = stopCamera;
            window.scanApp.openManualEntryModal = openManualEntryModal;
            window.scanApp.closeManualEntryModal = closeManualEntryModal;
            window.scanApp.goToHome = goToHome;
            window.scanApp.goBack = goBack;
            window.scanApp.viewReports = viewReports;
            
            // ============================================
            // INITIALIZE APPLICATION
            // ============================================
            
            // Initialize when page loads
            document.addEventListener('DOMContentLoaded', function() {
                console.log('DOM loaded, initializing app...');
                initApp();
            });
            
        })(); // End of isolated scope
        
        // ============================================
        // UPDATE HTML ONCLICK HANDLERS
        // ============================================
        
        // Update the onclick handlers in your HTML to use window.scanApp
        // Replace all onclick="functionName()" with onclick="window.scanApp.functionName()"
        
    </script>
    
    <script>
        // Quick fix for HTML onclick handlers
        // This script runs after the main app is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Update onclick handlers
            setTimeout(function() {
                // Update all buttons with onclick handlers
                const buttons = document.querySelectorAll('[onclick]');
                buttons.forEach(button => {
                    const onclick = button.getAttribute('onclick');
                    if (onclick) {
                        // Replace function calls with window.scanApp versions
                        const updatedOnclick = onclick
                            .replace(/selectScanType\(/g, 'window.scanApp.selectScanType(')
                            .replace(/openDisciplineSubtypes\(\)/g, 'window.scanApp.openDisciplineSubtypes()')
                            .replace(/closeDisciplineSubtypes\(\)/g, 'window.scanApp.closeDisciplineSubtypes()')
                            .replace(/selectDisciplineSubtype\(/g, 'window.scanApp.selectDisciplineSubtype(')
                            .replace(/confirmDisciplineSubtype\(\)/g, 'window.scanApp.confirmDisciplineSubtype()')
                            .replace(/requestCameraPermission\(\)/g, 'window.scanApp.requestCameraPermission()')
                            .replace(/startCamera\(\)/g, 'window.scanApp.startCamera()')
                            .replace(/stopCamera\(\)/g, 'window.scanApp.stopCamera()')
                            .replace(/openManualEntryModal\(\)/g, 'window.scanApp.openManualEntryModal()')
                            .replace(/closeManualEntryModal\(\)/g, 'window.scanApp.closeManualEntryModal()')
                            .replace(/goToHome\(\)/g, 'window.scanApp.goToHome()')
                            .replace(/goBack\(\)/g, 'window.scanApp.goBack()')
                            .replace(/viewReports\(\)/g, 'window.scanApp.viewReports()');
                        
                        button.setAttribute('onclick', updatedOnclick);
                    }
                });
                console.log('‚úÖ Updated onclick handlers');
            }, 100);
        });
    </script>
</body>
</html>
