<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Edit Student</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container py-5">
        <h2 class="mb-4">Edit Student</h2>
        <form id="editStudentForm">
            <div class="mb-3">
                <label for="studentId" class="form-label">Student ID</label>
                <input type="text" class="form-control" id="studentId" name="id" readonly>
            </div>
            <div class="mb-3">
                <label for="studentName" class="form-label">Name</label>
                <input type="text" class="form-control" id="studentName" name="name" required>
            </div>
            <div class="mb-3">
                <label for="studentClass" class="form-label">Class</label>
                <input type="number" class="form-control" id="studentClass" name="class" required>
            </div>
            <div class="mb-3">
                <label for="studentGender" class="form-label">Gender</label>
                <select class="form-select" id="studentGender" name="gender" required>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                    <option value="M">M</option>
                    <option value="F">F</option>
                </select>
            </div>
            <div class="mb-3">
                <label for="studentDob" class="form-label">Date of Birth</label>
                <input type="date" class="form-control" id="studentDob" name="dob" required>
            </div>
            <div class="mb-3">
                <label for="studentAddress" class="form-label">Address</label>
                <input type="text" class="form-control" id="studentAddress" name="address">
            </div>
            <div class="mb-3">
                <label for="studentPhone" class="form-label">Phone</label>
                <input type="text" class="form-control" id="studentPhone" name="phone">
            </div>
            <div class="mb-3">
                <label for="studentFather" class="form-label">Father</label>
                <input type="text" class="form-control" id="studentFather" name="father">
            </div>
            <div class="mb-3">
                <label for="studentMother" class="form-label">Mother</label>
                <input type="text" class="form-control" id="studentMother" name="mother">
            </div>
            <div class="mb-3">
                <label for="studentPhoto" class="form-label">Photo</label>
                <input type="file" class="form-control" id="studentPhoto" accept="image/*">
                <img id="photoPreview" src="" alt="Photo Preview" style="max-width:120px; margin-top:10px; display:none;">
            </div>
            <div class="mb-3">
                <label for="studyYear" class="form-label">Study Year</label>
                <input type="number" class="form-control" id="studyYear" name="studyYear">
            </div>
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <a href="student-list.html" class="btn btn-secondary ms-2">Cancel</a>
            <a href="index.html" class="btn btn-outline-success ms-2">Back to Home</a>
        </form>
    </div>
    <script>
        // Load student data from localStorage
        const student = JSON.parse(localStorage.getItem('editStudent'));
        if (!student) {
            alert('No student data found.');
            window.location.href = 'student-list.html';
        } else {
            document.getElementById('studentId').value = student.id || '';
            document.getElementById('studentName').value = student.name || '';
            document.getElementById('studentClass').value = student.class || '';
            document.getElementById('studentGender').value = student.gender || '';
            document.getElementById('studentDob').value = student.dob ? student.dob.split(' ')[0] : '';
            document.getElementById('studentAddress').value = student.address || '';
            document.getElementById('studentPhone').value = student.phone || '';
            document.getElementById('studentFather').value = student.father || '';
            document.getElementById('studentMother').value = student.mother || '';
            document.getElementById('studyYear').value = student.studyYear || '';
            // Show photo preview if exists
            if (student.photo) {
                const preview = document.getElementById('photoPreview');
                preview.src = student.photo;
                preview.style.display = 'block';
            }
        }

        // Preview photo on file select
        document.getElementById('studentPhoto').addEventListener('change', function(e) {
            const file = e.target.files[0];
            const preview = document.getElementById('photoPreview');
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    preview.src = evt.target.result;
                    preview.style.display = 'block';
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.style.display = 'none';
            }
        });

        // Save changes
        document.getElementById('editStudentForm').addEventListener('submit', function(e) {
            e.preventDefault();

            function saveAndRedirect(photoData) {
                const updatedStudent = {
                    id: document.getElementById('studentId').value,
                    name: document.getElementById('studentName').value,
                    class: document.getElementById('studentClass').value,
                    gender: document.getElementById('studentGender').value,
                    dob: document.getElementById('studentDob').value,
                    address: document.getElementById('studentAddress').value,
                    phone: document.getElementById('studentPhone').value,
                    father: document.getElementById('studentFather').value,
                    mother: document.getElementById('studentMother').value,
                    photo: photoData,
                    studyYear: document.getElementById('studyYear').value
                };

                let students = JSON.parse(localStorage.getItem('students')) || [];
                const index = students.findIndex(s => String(s.id) === String(updatedStudent.id));
                if (index !== -1) {
                    students[index] = updatedStudent;
                    localStorage.setItem('students', JSON.stringify(students));
                    alert('Student updated successfully!');
                    localStorage.removeItem('editStudent');
                    window.location.href = 'student-list.html';
                } else {
                    alert('Student not found!');
                }
            }

            const photoInput = document.getElementById('studentPhoto');
            if (photoInput.files && photoInput.files[0]) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    saveAndRedirect(evt.target.result);
                };
                reader.readAsDataURL(photoInput.files[0]);
            } else {
                // If no new photo selected, keep the old photo
                saveAndRedirect(student.photo || '');
            }
        });
    </script>
</body>
</html>