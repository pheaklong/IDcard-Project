<!DOCTYPE html>
<html lang="km">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·üí·ûÄ·üÅ·ûì·ûü·û∑·ûü·üí·ûü</title>
    <script>
        // Check login: if not logged in, redirect to login page
        if (localStorage.getItem('adminLoggedIn') !== 'true') {
            window.location.href = 'login.html';
        }
    </script>
    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- Chart.js for statistics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --primary-dark: #3a56d4;
            --secondary: #7209b7;
            --success: #4cc9f0;
            --success-dark: #2fb5e0;
            --warning: #f72585;
            --danger: #f94144;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border-radius: 16px;
            --shadow: 0 8px 24px rgba(0,0,0,0.12);
            --transition: all 0.3s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Khmer OS', 'Noto Sans Khmer', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: var(--dark);
        }

        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .header {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 30px 25px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 10px;
            font-weight: 700;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .back-buttons {
            display: flex;
            gap: 12px;
            padding: 18px 25px;
            background: var(--light);
            border-bottom: 1px solid #e9ecef;
        }

        .content {
            padding: 30px 25px;
        }

        .card {
            background: white;
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
            border: 1px solid #e9ecef;
        }

        .card-title {
            font-size: 1.4rem;
            font-weight: 600;
            margin-bottom: 20px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* Report Type Selection */
        .report-type-selection {
            margin-bottom: 25px;
        }

        .report-type-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 15px;
        }

        .report-type-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 12px;
        }

        .report-type-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow);
            border-color: var(--primary);
        }

        .report-type-card.selected {
            border-color: var(--primary);
            background: rgba(67, 97, 238, 0.05);
        }

        .report-type-icon {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .report-type-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }

        .report-type-desc {
            font-size: 0.9rem;
            color: var(--gray);
            line-height: 1.4;
        }

        /* Filter Section */
        .filter-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 25px;
        }

        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .form-group {
            margin-bottom: 0;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-size: 14px;
            transition: var(--transition);
            font-family: 'Khmer OS', 'Noto Sans Khmer', 'Arial', sans-serif;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(67, 97, 238, 0.15);
        }

        /* Stats Section */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 18px;
            margin: 25px 0;
        }

        .stat-card {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 12px 30px rgba(0,0,0,0.2);
        }

        .stat-number {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 1rem;
            opacity: 0.9;
        }

        /* Chart Container */
        .chart-container {
            height: 300px;
            margin: 25px 0;
            position: relative;
        }

        /* Button Styles */
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 30px;
        }

        .btn {
            padding: 15px 20px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            text-decoration: none;
            text-align: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        .btn-primary { 
            background: var(--primary);
            color: white; 
        }
        .btn-primary:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(67, 97, 238, 0.3);
        }

        .btn-success { 
            background: var(--success);
            color: white; 
        }
        .btn-success:hover:not(:disabled) {
            background: var(--success-dark);
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 201, 240, 0.3);
        }

        .btn-warning { 
            background: var(--warning);
            color: white; 
        }
        .btn-warning:hover:not(:disabled) {
            background: #e51775;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(247, 37, 133, 0.3);
        }

        .btn-info { 
            background: var(--secondary);
            color: white; 
        }
        .btn-info:hover:not(:disabled) {
            background: #65199e;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(114, 9, 183, 0.3);
        }

        .btn-danger { 
            background: var(--danger);
            color: white; 
        }
        .btn-danger:hover:not(:disabled) {
            background: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(249, 65, 68, 0.3);
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            margin: 25px 0;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            table-layout: auto;
        }

        .data-table th {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 15px 12px;
            text-align: left;
            font-weight: 600;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: visible;
            cursor: pointer;
            user-select: none;
            position: relative;
            transition: var(--transition);
            padding-right: 30px;
        }

        .data-table th:hover {
            background: linear-gradient(135deg, var(--primary-dark), var(--secondary));
        }

        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #e9ecef;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: visible;
            line-height: 1.4;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        /* Sort Icon Styles */
        .sort-icon {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            opacity: 0.8;
        }

        .sortable-header {
            position: relative;
            padding-right: 30px !important;
        }

        /* Additional styles for discipline description */
        .discipline-description {
            max-width: 300px;
            white-space: normal;
            word-wrap: break-word;
            line-height: 1.4;
            text-align: left;
        }
        
        /* Ensure table columns have proper spacing */
        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            min-width: 200px;
            max-width: 300px;
        }

        /* ·ûÄ·üÜ·ûé·ûè·üã·ûë·ûë·ûπ·ûÑ·û¢·ûî·üí·ûî·ûî·ûö·ûò·û∂·ûü·ûò·üí·ûö·û∂·ûî·üã·ûá·ûΩ·ûö·ûà·ûö·ûì·û∏·ûò·ûΩ·ûô·üó */
        .data-table th:nth-child(1),
        .data-table td:nth-child(1) {
            min-width: 60px;
            max-width: 60px;
        }

        .data-table th:nth-child(2),
        .data-table td:nth-child(2) {
            min-width: 200px;
            max-width: 200px;
        }

        .data-table th:nth-child(3),
        .data-table td:nth-child(3) {
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(4),
        .data-table td:nth-child(4) {
            min-width: 100px;
            max-width: 100px;
        }

        .data-table th:nth-child(5),
        .data-table td:nth-child(5) {
            min-width: 120px;
            max-width: 120px;
        }

        .data-table th:nth-child(6),
        .data-table td:nth-child(6) {
            min-width: 150px;
            max-width: 150px;
        }

        .data-table th:nth-child(7),
        .data-table td:nth-child(7) {
            min-width: 150px;
            max-width: 150px;
        }

        /* ·ûí·û∂·ûì·û∂·ûê·û∂·û¢·ûè·üí·ûê·ûî·ûë·ûò·û∑·ûì·ûí·üí·ûõ·û∂·ûÄ·üã·ûÖ·ûª·üá·ûÄ·üí·ûö·üÑ·ûò·ûì·üÖ·ûÄ·üí·ûì·ûª·ûÑ·ûÄ·üÑ·ûü·û∑·ûÄ·û∂ */
        .data-table td,
        .data-table th {
            text-overflow: clip;
        }

        /* ·ûÄ·û∂·ûö·ûÄ·üÇ·ûü·ûò·üí·ûö·ûΩ·ûõ·ûü·ûò·üí·ûö·û∂·ûî·üã·ûß·ûî·ûÄ·ûö·ûé·üç·ûÖ·ûõ·üê·ûè */
        @media (max-width: 768px) {
            .data-table th,
            .data-table td {
                font-size: 0.8rem;
                padding: 10px 8px;
                white-space: nowrap;
                overflow: visible;
            }
            
            .data-table th:nth-child(1),
            .data-table td:nth-child(1) {
                min-width: 50px;
                max-width: 50px;
            }
            
            .data-table th:nth-child(2),
            .data-table td:nth-child(2) {
                min-width: 150px;
                max-width: 150px;
            }
            
            .data-table th:nth-child(3),
            .data-table td:nth-child(3) {
                min-width: 100px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(4),
            .data-table td:nth-child(4) {
                min-width: 80px;
                max-width: 80px;
            }
            
            .data-table th:nth-child(5),
            .data-table td:nth-child(5) {
                min-width: 100px;
                max-width: 100px;
            }
            
            .data-table th:nth-child(6),
            .data-table td:nth-child(6) {
                min-width: 120px;
                max-width: 120px;
            }
            
            .data-table th:nth-child(7),
            .data-table td:nth-child(7) {
                min-width: 120px;
                max-width: 120px;
            }
            
            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            .sort-icon {
                right: 5px;
                font-size: 10px;
            }

            .sortable-header {
                padding-right: 25px !important;
            }
        }

        .badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-align: center;
            display: inline-block;
        }

        .badge-late {
            background: #fff3cd;
            color: #856404;
        }

        .badge-discipline {
            background: #f8d7da;
            color: #721c24;
        }

        .badge-helpful {
            background: #d1edff;
            color: #004085;
        }

        .badge-haircut {
            background: #d4edda;
            color: #155724;
        }

        /* Loading Animation */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px 20px;
            color: var(--gray);
        }

        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        /* Summary Report Styles */
        .summary-card {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            box-shadow: var(--shadow);
        }

        .summary-title {
            font-size: 1.3rem;
            font-weight: 600;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }

        .summary-stat {
            text-align: center;
            padding: 15px;
            background: rgba(255,255,255,0.2);
            border-radius: var(--border-radius);
        }

        .summary-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .summary-label {
            font-size: 0.9rem;
            opacity: 0.9;
        }

        /* Sort Button Styles */
        .sort-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .sort-btn {
            padding: 10px 16px;
            border: 2px solid var(--primary);
            background: white;
            color: var(--primary);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .sort-btn:hover {
            background: var(--primary);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }

        .sort-btn.active {
            background: var(--primary);
            color: white;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .button-grid {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .report-type-grid {
                grid-template-columns: 1fr;
            }
            
            .filter-grid {
                grid-template-columns: 1fr;
            }
            
            .header h1 {
                font-size: 1.6rem;
            }
            
            .header p {
                font-size: 1rem;
            }
            
            .card-title {
                font-size: 1.2rem;
            }
            
            .btn {
                padding: 14px 18px;
            }

            .summary-stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .sort-buttons {
                gap: 8px;
            }

            .sort-btn {
                padding: 8px 12px;
                font-size: 12px;
            }
        }

        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .header {
                padding: 25px 20px;
            }
            
            .back-buttons {
                flex-direction: column;
                gap: 10px;
            }

            .summary-stats {
                grid-template-columns: 1fr;
            }

            .sort-buttons {
                flex-direction: column;
            }

            .sort-btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- ... (·ûÄ·û∂·ûö·ûÄ·üÇ HTML ·ûä·ûä·üÇ·ûõ) ... -->

    <script>
        // Supabase Configuration
        const SUPABASE_URL = 'https://ovvlshbuayykddqrnoqx.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im92dmxzaGJ1YXl5a2RkcXJub3F4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NjQxODgsImV4cCI6MjA3NjM0MDE4OH0.vWLDFMS16PwZga9mYehVUiL6G0ccnRzdc9OUf2OM76I';
        
        // Initialize Supabase client
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Global variables
        let currentReportType = null;
        let allReports = [];
        let filteredReports = [];
        let chart = null;
        let students = [];
        let summaryData = [];
        let disciplineSummaryData = [];

        // Sorting variables
        let currentSort = { column: null, direction: 'asc' };
        let currentSummarySort = { column: null, direction: 'asc' };
        let currentDisciplineSummarySort = { column: null, direction: 'asc' };

        // Report type definitions
        const reportTypes = {
            late: {
                title: "·ûü·û∑·ûü·üí·ûü·ûò·ûÄ·ûô·û∫·ûè",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûò·ûÄ·ûô·û∫·ûè ·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûë·ûÑ·üã·ûá·û∂·ûè·û∑",
                table: "attendance_reports",
                type: "late",
                badge: "badge-late",
                badgeText: "·ûò·ûÄ·ûô·û∫·ûè",
                problemType: "·ûü·û∑·ûü·üí·ûü·ûò·ûÄ·ûô·û∫·ûè"
            },
            discipline: {
                title: "·ûü·û∑·ûü·üí·ûü·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô·ûü·û∂·ûõ·û∂",
                table: "discipline_reports",
                type: "discipline",
                badge: "badge-discipline",
                badgeText: "·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô",
                problemType: "discipline_description"
            },
            helpful: {
                title: "·ûü·û∑·ûü·üí·ûü·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûî·û∂·ûì·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö·ûü·û∂·ûõ·û∂",
                table: "helpful_reports",
                type: "helpful",
                badge: "badge-helpful",
                badgeText: "·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö",
                problemType: "·ûá·ûΩ·ûô·ûÄ·û∂·ûö·ûÑ·û∂·ûö·ûü·û∂·ûõ·û∂"
            },
            haircut: {
                title: "·ûü·û∑·ûü·üí·ûü·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûè·üã·ûü·ûÄ·üã",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·û∑·ûü·üí·ûü·ûä·üÇ·ûõ·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûè·üã·ûü·ûÄ·üã·ûè·û∂·ûò·ûú·û∑·ûì·üê·ûô",
                table: "haircut_reports",
                type: "haircut",
                badge: "badge-haircut",
                badgeText: "·ûè·üí·ûö·ûº·ûú·ûÄ·û∂·ûè·üã·ûü·ûÄ·üã",
                problemType: "·ûü·ûÄ·üã"
            },
            summary: {
                title: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·ûÑ·üí·ûÅ·üÅ·ûî",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûÖ·üÜ·ûì·ûΩ·ûì·ûä·ûÑ·ûü·û∑·ûü·üí·ûü·ûò·ûÄ·ûô·û∫·ûè·ûÄ·üí·ûì·ûª·ûÑ·ûò·ûΩ·ûô·ûü·ûî·üí·ûè·û∂·û†·üç/·ûÅ·üÇ",
                table: "attendance_reports",
                type: "summary"
            },
            'discipline-summary': {
                title: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûü·ûÑ·üí·ûÅ·üÅ·ûî·ûü·û∑·ûü·üí·ûü·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô",
                description: "·ûö·ûî·û∂·ûô·ûÄ·û∂·ûö·ûé·üç·ûÖ·üÜ·ûì·ûΩ·ûì·ûä·ûÑ·ûü·û∑·ûü·üí·ûü·ûò·û∑·ûì·ûÇ·üÑ·ûö·ûñ·ûú·û∑·ûì·üê·ûô·ûÄ·üí·ûì·ûª·ûÑ·ûò·ûΩ·ûô·ûü·ûî·üí·ûè·û∂·û†·üç/·ûÅ·üÇ",
                table: "discipline_reports",
                type: "discipline-summary"
            }
        };

        // ========== IMPROVED DATA LOADING FUNCTIONS ==========

        // Function to load data with pagination for large datasets
        async function loadAllData(tableName, batchSize = 1000) {
            let allData = [];
            let from = 0;
            let hasMore = true;
            
            console.log(`üîç Starting to load data from ${tableName}...`);
            
            while (hasMore) {
                try {
                    const { data, error, count } = await supabase
                        .from(tableName)
                        .select('*', { count: 'exact' })
                        .range(from, from + batchSize - 1)
                        .order('timestamp', { ascending: false });
                    
                    if (error) {
                        console.error(`‚ùå Error loading batch from ${from} to ${from + batchSize}:`, error);
                        throw error;
                    }
                    
                    if (data && data.length > 0) {
                        allData = allData.concat(data);
                        console.log(`‚úÖ Loaded batch ${Math.floor(from/batchSize) + 1}: ${data.length} records (Total: ${allData.length})`);
                        
                        // Update loading progress
                        updateLoadingProgress(tableName, allData.length, count);
                    }
                    
                    // Check if there's more data to load
                    if (!data || data.length < batchSize) {
                        hasMore = false;
                        console.log(`üéâ Finished loading all ${allData.length} records from ${tableName}`);
                    } else {
                        from += batchSize;
                    }
                    
                    // Small delay to prevent overwhelming the server
                    await new Promise(resolve => setTimeout(resolve, 100));
                    
                } catch (error) {
                    console.error(`‚ùå Error in loadAllData for ${tableName}:`, error);
                    
                    // Fallback to localStorage if available
                    const localData = JSON.parse(localStorage.getItem(`${getLocalStorageKey(tableName)}`) || '[]');
                    if (localData.length > 0) {
                        console.log(`üì± Fallback to localStorage: ${localData.length} records`);
                        return localData;
                    }
                    
                    throw error;
                }
            }
            
            // Cache the data in localStorage for offline use
            if (allData.length > 0) {
                try {
                    localStorage.setItem(`${getLocalStorageKey(tableName)}`, JSON.stringify(allData));
                    console.log(`üíæ Cached ${allData.length} records to localStorage`);
                } catch (storageError) {
                    console.warn('‚ö†Ô∏è Could not cache data to localStorage:', storageError);
                }
            }
            
            return allData;
        }

        // Helper function to get localStorage key based on table name
        function getLocalStorageKey(tableName) {
            const keyMap = {
                'attendance_reports': 'lateReports',
                'discipline_reports': 'disciplineReports',
                'helpful_reports': 'helpfulReports',
                'haircut_reports': 'haircutReports'
            };
            return keyMap[tableName] || `${tableName}Data`;
        }

        // Update loading progress UI
        function updateLoadingProgress(tableName, currentCount, totalCount) {
            const loadingElement = document.getElementById('table-loading') || 
                                 document.getElementById('summary-loading') || 
                                 document.getElementById('discipline-summary-loading');
            
            if (loadingElement) {
                if (totalCount) {
                    const progress = Math.min(100, Math.round((currentCount / totalCount) * 100));
                    loadingElement.innerHTML = `
                        <div class="loading"></div>
                        <p>·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûë·ûª·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô... ${progress}%</p>
                        <p style="font-size: 0.8rem; margin-top: 5px;">${currentCount} / ${totalCount} ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</p>
                    `;
                } else {
                    loadingElement.innerHTML = `
                        <div class="loading"></div>
                        <p>·ûÄ·üÜ·ûñ·ûª·ûÑ·ûï·üí·ûë·ûª·ûÄ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô... ${currentCount} ·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô</p>
                    `;
                }
            }
        }

        // ========== ENHANCED DATA LOADING FOR EACH REPORT TYPE ==========

        // Load discipline summary report with improved data loading
        async function loadDisciplineSummaryReport() {
            if (currentReportType !== 'discipline-summary') return;
            
            document.getElementById('discipline-summary-loading').style.display = 'block';
            document.getElementById('discipline-summary-empty').style.display = 'none';
            document.getElementById('discipline-summary-table-body').innerHTML = '';
            
            try {
                const tableName = "discipline_reports";
                console.log(`üîç Loading discipline summary data from ${tableName}...`);
                
                allReports = await loadAllData(tableName);
                console.log(`‚úÖ Successfully loaded ${allReports.length} discipline records for summary`);
                
                updateDisciplineSummaryReport();
                
            } catch (error) {
                console.error('‚ùå Error loading discipline summary data:', error);
                allReports = JSON.parse(localStorage.getItem('disciplineReports') || '[]');
                console.log(`üì± Fallback to localStorage: ${allReports.length} discipline records`);
                updateDisciplineSummaryReport();
            }
        }

        // Load summary report with improved data loading
        async function loadSummaryReport() {
            if (currentReportType !== 'summary') return;
            
            document.getElementById('summary-loading').style.display = 'block';
            document.getElementById('summary-empty').style.display = 'none';
            document.getElementById('summary-table-body').innerHTML = '';
            
            try {
                const tableName = "attendance_reports";
                console.log(`üîç Loading summary data from ${tableName}...`);
                
                allReports = await loadAllData(tableName);
                console.log(`‚úÖ Successfully loaded ${allReports.length} records for summary`);
                
                updateSummaryReport();
                
            } catch (error) {
                console.error('‚ùå Error loading summary data:', error);
                allReports = JSON.parse(localStorage.getItem('lateReports') || '[]');
                console.log(`üì± Fallback to localStorage: ${allReports.length} records`);
                updateSummaryReport();
            }
        }

        // Load regular report data with improved data loading
        async function loadReportData() {
            if (!currentReportType || currentReportType === 'summary' || currentReportType === 'discipline-summary') return;
            
            document.getElementById('table-loading').style.display = 'block';
            document.getElementById('table-empty').style.display = 'none';
            document.getElementById('report-table-body').innerHTML = '';
            
            try {
                const tableName = reportTypes[currentReportType].table;
                console.log(`üîç Loading data from ${tableName}...`);
                
                allReports = await loadAllData(tableName);
                console.log(`‚úÖ Successfully loaded ${allReports.length} records`);
                
                applyFilters();
                updateStats();
                populateClassFilter();
                
            } catch (error) {
                console.error('‚ùå Error loading report data:', error);
                allReports = JSON.parse(localStorage.getItem(`${currentReportType}Reports`) || '[]');
                console.log(`üì± Fallback to localStorage: ${allReports.length} records`);
                applyFilters();
                updateStats();
                populateClassFilter();
            }
        }

        // ========== OPTIMIZED DATA PROCESSING FUNCTIONS ==========

        // Optimized function to process large datasets for summary reports
        function processSummaryData(reports, startDate, endDate, minCount, classFilter) {
            console.log(`üîÑ Processing ${reports.length} records for summary...`);
            
            const studentCounts = {};
            const studentLastDate = {};
            const studentDetails = {};
            const studentMainProblems = {};
            
            // Use for loop for better performance with large arrays
            for (let i = 0; i < reports.length; i++) {
                const report = reports[i];
                const reportDate = new Date(report.date);
                
                // Skip if outside date range
                if (reportDate < startDate || reportDate > endDate) continue;
                
                const studentId = report.student_id;
                
                if (!studentCounts[studentId]) {
                    studentCounts[studentId] = 0;
                    studentDetails[studentId] = {
                        name: report.name,
                        class: report.class,
                        gender: report.gender || '·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô'
                    };
                    if (currentReportType === 'discipline-summary') {
                        studentMainProblems[studentId] = {};
                    }
                }
                
                studentCounts[studentId]++;
                
                // For discipline summary, track main problems
                if (currentReportType === 'discipline-summary') {
                    const problem = report.discipline_description || '·ûò·û∑·ûì·ûò·û∂·ûì·ûÄ·û∂·ûö·ûñ·û∑·ûñ·ûé·üå·ûì·û∂';
                    studentMainProblems[studentId][problem] = (studentMainProblems[studentId][problem] || 0) + 1;
                }
                
                // Update last date
                if (!studentLastDate[studentId] || reportDate > studentLastDate[studentId]) {
                    studentLastDate[studentId] = reportDate;
                }
            }
            
            // Convert to array and filter
            const result = [];
            const studentIds = Object.keys(studentCounts);
            
            for (let i = 0; i < studentIds.length; i++) {
                const studentId = studentIds[i];
                const count = studentCounts[studentId];
                
                // Apply filters
                if (count < minCount) continue;
                if (classFilter !== 'all' && studentDetails[studentId].class !== classFilter) continue;
                
                const item = {
                    student_id: studentId,
                    name: studentDetails[studentId].name,
                    class: studentDetails[studentId].class,
                    gender: studentDetails[studentId].gender,
                    count: count,
                    last_date: studentLastDate[studentId]
                };
                
                // Add main problem for discipline summary
                if (currentReportType === 'discipline-summary') {
                    const problems = studentMainProblems[studentId];
                    const mainProblem = Object.keys(problems).reduce((a, b) => problems[a] > problems[b] ? a : b, '·ûò·û∑·ûì·ûò·û∂·ûì·ûÄ·û∂·ûö·ûñ·û∑·ûñ·ûé·üå·ûì·û∂');
                    item.main_problem = mainProblem;
                }
                
                result.push(item);
            }
            
            // Sort by count (descending)
            result.sort((a, b) => b.count - a.count);
            
            console.log(`‚úÖ Processed ${result.length} students from ${reports.length} records`);
            return result;
        }

        // ========== ENHANCED FILTERING FOR LARGE DATASETS ==========

        // Optimized filter function for large datasets
        function applyFilters() {
            if (!currentReportType || currentReportType === 'summary' || currentReportType === 'discipline-summary' || allReports.length === 0) {
                document.getElementById('table-loading').style.display = 'none';
                document.getElementById('table-empty').style.display = 'block';
                return;
            }
            
            console.log(`üîÑ Applying filters to ${allReports.length} records...`);
            
            let filtered = [];
            const dateFilter = document.getElementById('date-filter').value;
            const today = new Date();
            
            // Use for loop for better performance
            for (let i = 0; i < allReports.length; i++) {
                const report = allReports[i];
                let include = true;
                
                // Date filtering
                switch (dateFilter) {
                    case 'today':
                        const todayStr = today.toISOString().split('T')[0];
                        if (report.date !== todayStr) include = false;
                        break;
                    case 'today-tomorrow':
                        const todayDate = new Date();
                        const tomorrow = new Date(todayDate);
                        tomorrow.setDate(tomorrow.getDate() + 1);
                        const todayString = todayDate.toISOString().split('T')[0];
                        const tomorrowString = tomorrow.toISOString().split('T')[0];
                        if (report.date !== todayString && report.date !== tomorrowString) include = false;
                        break;
                    case 'yesterday':
                        const yesterday = new Date(today);
                        yesterday.setDate(yesterday.getDate() - 1);
                        const yesterdayStr = yesterday.toISOString().split('T')[0];
                        if (report.date !== yesterdayStr) include = false;
                        break;
                    case 'week':
                        const weekAgo = new Date(today);
                        weekAgo.setDate(weekAgo.getDate() - 7);
                        const reportDate = new Date(report.date);
                        if (reportDate < weekAgo || reportDate > today) include = false;
                        break;
                    case 'month':
                        const monthAgo = new Date(today);
                        monthAgo.setMonth(monthAgo.getMonth() - 1);
                        const reportDateMonth = new Date(report.date);
                        if (reportDateMonth < monthAgo || reportDateMonth > today) include = false;
                        break;
                    case 'custom':
                        const customDate = document.getElementById('custom-date').value;
                        if (customDate && report.date !== customDate) include = false;
                        break;
                    case 'date-range':
                        const startDate = document.getElementById('start-date').value;
                        const endDate = document.getElementById('end-date').value;
                        if (startDate && endDate) {
                            const reportDateRange = new Date(report.date);
                            const start = new Date(startDate);
                            const end = new Date(endDate);
                            start.setHours(0, 0, 0, 0);
                            end.setHours(23, 59, 59, 999);
                            if (reportDateRange < start || reportDateRange > end) include = false;
                        }
                        break;
                }
                
                // Class filtering
                const classFilter = document.getElementById('class-filter').value;
                if (include && classFilter !== 'all' && report.class !== classFilter) {
                    include = false;
                }
                
                // Search filtering
                const searchFilter = document.getElementById('search-filter').value.toLowerCase();
                if (include && searchFilter) {
                    const matchesName = report.name.toLowerCase().includes(searchFilter);
                    const matchesId = report.student_id && report.student_id.toLowerCase().includes(searchFilter);
                    const matchesDescription = report.discipline_description && report.discipline_description.toLowerCase().includes(searchFilter);
                    
                    if (!matchesName && !matchesId && !matchesDescription) {
                        include = false;
                    }
                }
                
                if (include) {
                    filtered.push(report);
                }
            }
            
            filteredReports = filtered;
            console.log(`‚úÖ Filtered to ${filteredReports.length} records`);
            renderTable();
            updateStats();
        }

        // ========== ENHANCED RENDERING FOR LARGE TABLES ==========

        // Virtual scrolling for large tables (optional enhancement)
        function renderTable() {
            const tableBody = document.getElementById('report-table-body');
            const tableLoading = document.getElementById('table-loading');
            const tableEmpty = document.getElementById('table-empty');
            
            tableLoading.style.display = 'none';
            
            if (filteredReports.length === 0) {
                tableEmpty.style.display = 'block';
                tableBody.innerHTML = '';
                document.getElementById('stats-section').style.display = 'none';
                return;
            }
            
            tableEmpty.style.display = 'none';
            
            // For very large datasets, consider implementing virtual scrolling
            if (filteredReports.length > 1000) {
                renderTableWithVirtualScroll();
            } else {
                renderFullTable();
            }
            
            document.getElementById('table-section').style.display = 'block';
            document.getElementById('stats-section').style.display = 'grid';
        }

        // Render full table for smaller datasets
        function renderFullTable() {
            const tableBody = document.getElementById('report-table-body');
            let html = '';
            
            for (let i = 0; i < filteredReports.length; i++) {
                const report = filteredReports[i];
                const dateObj = new Date(report.date);
                const displayDate = dateObj.toLocaleDateString('km-KH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let problemTypeText = '';
                if (currentReportType === 'discipline') {
                    problemTypeText = report.discipline_description || '·ûò·û∑·ûì·ûò·û∂·ûì·ûÄ·û∂·ûö·ûñ·û∑·ûñ·ûé·üå·ûì·û∂';
                } else {
                    problemTypeText = reportTypes[currentReportType].problemType;
                }
                
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>
                            <div><strong>${report.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--gray);">ID: ${report.student_id}</div>
                        </td>
                        <td>${report.class}</td>
                        <td>${report.gender || '·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô'}</td>
                        <td class="discipline-description">
                            <div>${problemTypeText}</div>
                        </td>
                        <td>${report.scan_time || report.late_time || 'N/A'}</td>
                        <td>${displayDate}</td>
                    </tr>
                `;
            }
            
            tableBody.innerHTML = html;
        }

        // Basic virtual scrolling implementation for very large tables
        function renderTableWithVirtualScroll() {
            const tableBody = document.getElementById('report-table-body');
            const visibleRows = 50; // Number of rows to render at once
            
            console.log(`üîÑ Implementing virtual scrolling for ${filteredReports.length} records`);
            
            // Initial render
            renderTableChunk(0, visibleRows);
            
            // Add scroll event listener for virtual scrolling
            const tableContainer = document.querySelector('.table-container');
            tableContainer.onscroll = function() {
                const scrollTop = tableContainer.scrollTop;
                const scrollHeight = tableContainer.scrollHeight;
                const clientHeight = tableContainer.clientHeight;
                
                // Load more rows when near bottom
                if (scrollTop + clientHeight >= scrollHeight - 100) {
                    const currentRows = tableBody.children.length;
                    if (currentRows < filteredReports.length) {
                        renderTableChunk(currentRows, currentRows + visibleRows);
                    }
                }
            };
        }

        function renderTableChunk(start, end) {
            const tableBody = document.getElementById('report-table-body');
            let html = '';
            
            const chunkEnd = Math.min(end, filteredReports.length);
            
            for (let i = start; i < chunkEnd; i++) {
                const report = filteredReports[i];
                const dateObj = new Date(report.date);
                const displayDate = dateObj.toLocaleDateString('km-KH', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                });
                
                let problemTypeText = '';
                if (currentReportType === 'discipline') {
                    problemTypeText = report.discipline_description || '·ûò·û∑·ûì·ûò·û∂·ûì·ûÄ·û∂·ûö·ûñ·û∑·ûñ·ûé·üå·ûì·û∂';
                } else {
                    problemTypeText = reportTypes[currentReportType].problemType;
                }
                
                html += `
                    <tr>
                        <td>${i + 1}</td>
                        <td>
                            <div><strong>${report.name}</strong></div>
                            <div style="font-size: 0.8rem; color: var(--gray);">ID: ${report.student_id}</div>
                        </td>
                        <td>${report.class}</td>
                        <td>${report.gender || '·ûò·û∑·ûì·ûò·û∂·ûì·ûë·û∑·ûì·üí·ûì·ûì·üê·ûô'}</td>
                        <td class="discipline-description">
                            <div>${problemTypeText}</div>
                        </td>
                        <td>${report.scan_time || report.late_time || 'N/A'}</td>
                        <td>${displayDate}</td>
                    </tr>
                `;
            }
            
            if (start === 0) {
                tableBody.innerHTML = html;
            } else {
                tableBody.innerHTML += html;
            }
        }

        // ========== OTHER OPTIMIZATIONS ==========

        // Optimized class filter population
        function populateClassFilter() {
            const classFilter = document.getElementById('class-filter');
            const classes = new Set();
            
            // Use Set for better performance with large arrays
            for (let i = 0; i < allReports.length; i++) {
                classes.add(allReports[i].class);
            }
            
            const sortedClasses = Array.from(classes).sort();
            classFilter.innerHTML = '<option value="all">·ûë·û∂·üÜ·ûÑ·û¢·ûü·üã</option>';
            
            for (let i = 0; i < sortedClasses.length; i++) {
                const option = document.createElement('option');
                option.value = sortedClasses[i];
                option.textContent = sortedClasses[i];
                classFilter.appendChild(option);
            }
        }

        // Optimized stats calculation
        function updateStats() {
            if (!currentReportType || currentReportType === 'summary' || currentReportType === 'discipline-summary') return;
            
            const totalScans = allReports.length;
            
            // Calculate today's scans
            const today = new Date().toISOString().split('T')[0];
            let todayScans = 0;
            for (let i = 0; i < allReports.length; i++) {
                if (allReports[i].date === today) {
                    todayScans++;
                }
            }
            
            // Calculate unique students using Set
            const uniqueStudents = new Set();
            for (let i = 0; i < allReports.length; i++) {
                uniqueStudents.add(allReports[i].student_id);
            }
            
            // Calculate most frequent scans
            const studentCounts = {};
            for (let i = 0; i < allReports.length; i++) {
                const studentId = allReports[i].student_id;
                studentCounts[studentId] = (studentCounts[studentId] || 0) + 1;
            }
            
            const mostFrequent = Math.max(...Object.values(studentCounts), 0);
            
            document.getElementById('total-scans').textContent = totalScans.toLocaleString();
            document.getElementById('today-scans').textContent = todayScans.toLocaleString();
            document.getElementById('unique-students').textContent = uniqueStudents.size.toLocaleString();
            document.getElementById('most-frequent').textContent = mostFrequent.toLocaleString();
        }

        // ========== REMAINING FUNCTIONS (unchanged) ==========

        // ... (·ûÄ·û∂·ûö·ûÄ·üÇ functions ·ûä·üÇ·ûõ·ûì·üÖ·ûü·ûõ·üã·ûä·ûº·ûÖ·ûÇ·üí·ûì·û∂) ...

        // Initialize page
        window.onload = function() {
            console.log('üìä Report page loaded - Enhanced for large datasets');
            
            // Add event listeners for period changes
            document.getElementById('date-filter').addEventListener('change', handleDateFilterChange);
            document.getElementById('discipline-summary-period').addEventListener('change', handleDisciplineSummaryPeriodChange);
            document.getElementById('summary-period').addEventListener('change', handleSummaryPeriodChange);
            
            selectReportType('discipline');
        };

        // Function to go back to home page
        function goToHome() {
            window.location.href = 'index.html';
        }

        // Function to go to scanner page
        function goToScanner() {
            window.location.href = 'scan.html';
        }
    </script>
</body>
</html>
